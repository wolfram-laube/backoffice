# =============================================================================
# MAB RUNNER INTELLIGENCE â€” v2
# =============================================================================
# Multi-Armed Bandit integration for learning optimal runner selection.
#
# Architecture (see INF-002):
#   runner-fallback  â†’ AVAILABILITY: "Is anyone alive?"
#   mab-integration  â†’ LEARNING:     "Who performs best?"
#   nsai/            â†’ REASONING:    "Why that one?"
#
# How it works:
#   1. mab:report (passive, .post stage):
#      After every pipeline, queries ALL completed jobs and reports
#      their outcomes (success, duration, runner) to the MAB service.
#      Zero changes needed to existing jobs.
#
#   2. mab:recommend (active, .pre stage):
#      Before a pipeline, queries MAB for the optimal runner.
#      Currently informational â€” GitLab tags are static, so actual
#      selection requires future child-pipeline integration.
#
#   3. mab:stats (manual):
#      Dashboard of MAB learning state.
#
# MAB Service: Cloud Run (UCB1 algorithm)
# =============================================================================

variables:
  MAB_SERVICE_URL: "https://runner-bandit-m5cziijwqa-lz.a.run.app"

# -----------------------------------------------------------------------------
# REPORT: Passive pipeline-level outcome reporting
# -----------------------------------------------------------------------------
# Runs in .post stage after ALL jobs complete. Queries GitLab API for
# every job in this pipeline, extracts runner + outcome, and bulk-reports
# to MAB service. No changes needed to any existing job.
# -----------------------------------------------------------------------------
mab:report:
  stage: .post
  image: python:3.11-slim
  tags:
    - docker-any
  variables:
    GIT_STRATEGY: clone
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl jq > /dev/null 2>&1
    - pip install --quiet requests PyYAML google-cloud-bigquery google-auth
    - pip install -e services/nsai/ --quiet 2>/dev/null || pip install PyYAML --quiet
  script:
    - |
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  MAB Outcome Reporter"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      MAB_URL="${MAB_SERVICE_URL}"
      API_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs"
      REPORTED=0
      SKIPPED=0
      ERRORS=0

      echo ""
      echo "ğŸ“¡ Querying pipeline #${CI_PIPELINE_ID} jobs..."

      # Get all jobs from this pipeline
      JOBS=$(curl -sf --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
        "${API_URL}?per_page=100" 2>/dev/null)

      if [ -z "$JOBS" ]; then
        echo "âš ï¸  Could not query pipeline jobs (token missing?)"
        exit 0
      fi

      echo "$JOBS" | jq -c '.[]' | while read -r JOB; do
        JOB_NAME=$(echo "$JOB" | jq -r '.name')
        JOB_STATUS=$(echo "$JOB" | jq -r '.status')
        RUNNER_DESC=$(echo "$JOB" | jq -r '.runner.description // empty')
        DURATION=$(echo "$JOB" | jq -r '.duration // 0')

        # Skip: no runner (manual/skipped), still running, or this job itself
        if [ -z "$RUNNER_DESC" ] || [ "$JOB_STATUS" = "running" ] || \
           [ "$JOB_STATUS" = "pending" ] || [ "$JOB_STATUS" = "created" ] || \
           [ "$JOB_STATUS" = "manual" ] || [ "$JOB_NAME" = "mab:report" ]; then
          SKIPPED=$((SKIPPED + 1))
          continue
        fi

        # Skip shared runners (only learn from our fleet)
        case "$RUNNER_DESC" in
          *saas*|*shared-gitlab*|*runners-manager*|*windows-shared*)
            SKIPPED=$((SKIPPED + 1))
            continue
            ;;
        esac

        # Determine success
        SUCCESS="false"
        [ "$JOB_STATUS" = "success" ] && SUCCESS="true"

        # Report to MAB
        RESPONSE=$(curl -sf -X POST "${MAB_URL}/update" \
          -H "Content-Type: application/json" \
          -d "{\"runner\":\"${RUNNER_DESC}\",\"success\":${SUCCESS},\"duration\":${DURATION},\"job_name\":\"${JOB_NAME}\",\"project\":\"${CI_PROJECT_NAME}\"}" \
          2>&1) || true

        if [ -n "$RESPONSE" ]; then
          echo "  ğŸ“Š ${JOB_NAME} â†’ ${RUNNER_DESC} | ${JOB_STATUS} | ${DURATION}s"
          REPORTED=$((REPORTED + 1))
        else
          echo "  âš ï¸  ${JOB_NAME} â†’ report failed"
          ERRORS=$((ERRORS + 1))
        fi
      done

      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "  Reported: ${REPORTED} | Skipped: ${SKIPPED} | Errors: ${ERRORS}"

      # Quick stats check
      echo ""
      echo "ğŸ“ˆ Current MAB state:"
      curl -sf "${MAB_URL}/stats" 2>/dev/null | jq '{
        algorithm,
        total_observations,
        runners: [.runners | to_entries[] | {
          name: .key,
          pulls: .value.pulls,
          success_rate: (.value.success_rate * 100 | floor / 100),
          avg_duration: (.value.avg_duration | floor)
        }]
      }' 2>/dev/null || echo "  (MAB service unreachable)"

    # â”€â”€ NSAI Shadow Comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - |
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  NSAI Shadow Comparator"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      python scripts/nsai_shadow.py \
        --pipeline-id "${CI_PIPELINE_ID}" \
        --project-id "${CI_PROJECT_ID}" \
        --project-name "${CI_PROJECT_NAME}" \
        --token "${GITLAB_API_TOKEN}" \
        --mab-url "${MAB_SERVICE_URL}" \
        || echo "âš ï¸  NSAI shadow comparison failed (non-fatal)"
  artifacts:
    paths:
      - nsai-shadow.json
    expire_in: 90 days
    when: always
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $MAB_DISABLED == "true"
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - if: $CI_PIPELINE_SOURCE == "api"
      when: always
  allow_failure: true

# -----------------------------------------------------------------------------
# RECOMMEND: Query MAB for optimal runner (informational)
# -----------------------------------------------------------------------------
# Currently informational â€” GitLab tags are static, so we can't
# dynamically route jobs. Future: child-pipeline integration.
#
# For now, this job:
#   1. Queries MAB for recommendation
#   2. Exports MAB_RUNNER_TAG as dotenv artifact
#   3. Logs the recommendation for observability
# -----------------------------------------------------------------------------
mab:recommend:
  stage: .pre
  image: alpine:latest
  tags:
    - docker-any
  variables:
    GIT_STRATEGY: none
  before_script:
    - apk add --no-cache curl jq > /dev/null 2>&1
  script:
    - |
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  MAB Runner Recommendation"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      RESPONSE=$(curl -sf --max-time 5 "${MAB_SERVICE_URL}/recommend" 2>&1)

      if [ -z "$RESPONSE" ]; then
        echo "âš ï¸  MAB unreachable, using default"
        echo "MAB_RUNNER_TAG=docker-any" > mab.env
        echo "MAB_RUNNER_NAME=none" >> mab.env
        echo "MAB_CONFIDENCE=0" >> mab.env
      else
        echo "$RESPONSE" | jq .
        RUNNER=$(echo "$RESPONSE" | jq -r '.recommended_runner // "unknown"')
        echo ""
        echo "ğŸ¯ Recommendation: ${RUNNER}"
        echo ""
        echo "MAB_RUNNER_TAG=docker-any" > mab.env
        echo "MAB_RUNNER_NAME=${RUNNER}" >> mab.env
      fi

      cat mab.env
  artifacts:
    reports:
      dotenv: mab.env
    expire_in: 1 hour
  rules:
    - if: $MAB_ENABLED == "true"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true

# -----------------------------------------------------------------------------
# STATS: MAB Dashboard
# -----------------------------------------------------------------------------
mab:stats:
  stage: deploy
  image: alpine:latest
  tags:
    - docker-any
  variables:
    GIT_STRATEGY: none
  before_script:
    - apk add --no-cache curl jq > /dev/null 2>&1
  script:
    - |
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  MAB Runner Statistics"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      curl -sf "${MAB_SERVICE_URL}/stats" | jq .

      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "  Current Recommendation"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      curl -sf "${MAB_SERVICE_URL}/recommend" | jq .
  rules:
    - when: manual
  allow_failure: true
