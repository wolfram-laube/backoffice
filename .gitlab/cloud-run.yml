# Cloud Run Deployment Pipeline for Runner Bandit Service
# Builds and deploys the MAB service to GCP Cloud Run
#
# Required CI Variables (Group Level):
#   - GCP_SERVICE_ACCOUNT_KEY: Base64-encoded service account JSON
#
# Triggers:
#   - Manual via web UI
#   - Tag push (v*)

variables:
  GCP_PROJECT: myk8sproject-207017
  GCP_REGION: europe-north1
  SERVICE_NAME: runner-bandit
  IMAGE_NAME: europe-north1-docker.pkg.dev/${GCP_PROJECT}/backoffice/${SERVICE_NAME}

# ============== Build & Push to Artifact Registry ==============
cloud-run:build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.19.2-debug
    entrypoint: [""]
  tags:
    - docker-any
  rules:
    - if: '$CLOUD_RUN_DEPLOY == "true"'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
  script:
    - echo "=== Setting up GCP Auth for Kaniko ==="
    - mkdir -p /kaniko/.docker
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /kaniko/gcp-key.json
    - export GOOGLE_APPLICATION_CREDENTIALS=/kaniko/gcp-key.json
    - echo "=== Building with Kaniko ==="
    - /kaniko/executor --context="${CI_PROJECT_DIR}/services/runner_bandit" --dockerfile="${CI_PROJECT_DIR}/services/runner_bandit/Dockerfile" --destination="${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}" --destination="${IMAGE_NAME}:latest" --cache=false
    - echo "Build complete! Image pushed to ${IMAGE_NAME}"

# ============== Deploy to Cloud Run ==============
cloud-run:deploy:
  stage: deploy
  image: google/cloud-sdk:slim
  tags:
    - docker-any
  needs:
    - cloud-run:build
  rules:
    - if: '$CLOUD_RUN_DEPLOY == "true"'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
  script:
    - echo "=== Authenticating with GCP ==="
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    - echo "=== Deploying to Cloud Run ==="
    - gcloud run deploy $SERVICE_NAME --image=${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} --region=$GCP_REGION --platform=managed --allow-unauthenticated --memory=256Mi --cpu=1 --min-instances=0 --max-instances=2 --port=8080 --set-env-vars=BANDIT_ALGORITHM=ucb1,BANDIT_STATE_FILE=/tmp/bandit_state.json
    - echo "=== Getting Service URL ==="
    - SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$GCP_REGION --format='value(status.url)')
    - echo "SERVICE_URL=${SERVICE_URL}" >> deploy.env
    - echo "Deployed! Service URL ${SERVICE_URL}"
  artifacts:
    reports:
      dotenv: deploy.env

# ============== Smoke Test ==============
cloud-run:test:
  stage: test
  image: curlimages/curl:latest
  tags:
    - docker-any
  needs:
    - cloud-run:deploy
  rules:
    - if: '$CLOUD_RUN_DEPLOY == "true"'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
  script:
    - echo "=== Smoke Test ==="
    - echo "Service URL ${SERVICE_URL}"
    - echo "Testing health endpoint..."
    - curl -sf "${SERVICE_URL}/" | head -c 200
    - echo "Testing recommendation endpoint..."
    - curl -sf "${SERVICE_URL}/recommend" | head -c 500
    - echo "Smoke test passed!"
