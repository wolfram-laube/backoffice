# =============================================================================
# GCP Nordic Migration Pipeline
# =============================================================================
# Migriert clarissa-runner von europe-west1-b nach europe-north1-a
# =============================================================================

variables:
  OLD_ZONE: "europe-west1-b"
  NEW_ZONE: "europe-north1-a"
  OLD_VM_NAME: "clarissa-runner"
  NEW_VM_NAME: "nordic-runner"
  GCP_PROJECT: "myk8sproject-207017"
  MACHINE_TYPE: "e2-micro"
  DISK_SIZE: "30GB"

# -----------------------------------------------------------------------------
# Phase 1: Backup & Snapshot
# -----------------------------------------------------------------------------
migration:backup:
  stage: .pre
  tags: [gcp-shell]
  rules:
    - if: $MIGRATION_PHASE == "backup"
      when: always
    - when: never
  script:
    - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    - echo "â•‘  Phase 1 - Backup & Snapshot                                  â•‘"
    - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    - echo "ğŸ“ Backing up GitLab Runner config..."
    - sudo cat /etc/gitlab-runner/config.toml > runner-config-backup.toml
    - echo "   âœ“ Config saved"
    - export SNAPSHOT_NAME="clarissa-runner-snapshot-$(date +%Y%m%d-%H%M)"
    - echo "ğŸ“¸ Creating snapshot $SNAPSHOT_NAME..."
    - gcloud compute disks snapshot $OLD_VM_NAME --zone=$OLD_ZONE --snapshot-names=$SNAPSHOT_NAME --description="Pre-migration snapshot for Nordic migration"
    - echo "   âœ“ Snapshot created"
    - echo "âœ… Verifying snapshot..."
    - gcloud compute snapshots describe $SNAPSHOT_NAME --format="table(name,status,diskSizeGb)"
    - echo "SNAPSHOT_NAME=$SNAPSHOT_NAME" > migration.env
    - echo ""
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "âœ… Phase 1 complete!"
    - echo "Next - Run pipeline with MIGRATION_PHASE=create"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  artifacts:
    paths:
      - runner-config-backup.toml
      - migration.env
    expire_in: 7 days

# -----------------------------------------------------------------------------
# Phase 2: Create VM in new region
# -----------------------------------------------------------------------------
migration:create:
  stage: .pre
  tags: [gcp-shell]
  rules:
    - if: $MIGRATION_PHASE == "create"
      when: always
    - when: never
  script:
    - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    - echo "â•‘  Phase 2 - Create VM in europe-north1                        â•‘"
    - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    - export SNAPSHOT_NAME=$(gcloud compute snapshots list --filter="name~clarissa-runner-snapshot" --sort-by=~creationTimestamp --limit=1 --format="value(name)")
    - echo "ğŸ“¸ Using snapshot - $SNAPSHOT_NAME"
    - export IMAGE_NAME="nordic-runner-image-$(date +%Y%m%d)"
    - echo "ğŸ–¼ï¸  Creating image $IMAGE_NAME..."
    - gcloud compute images create $IMAGE_NAME --source-snapshot=$SNAPSHOT_NAME --description="Image for Nordic runner migration" || echo "Image might already exist"
    - echo "ğŸ–¥ï¸  Creating VM $NEW_VM_NAME in $NEW_ZONE..."
    - gcloud compute instances create $NEW_VM_NAME --zone=$NEW_ZONE --machine-type=$MACHINE_TYPE --image=$IMAGE_NAME --boot-disk-size=$DISK_SIZE --boot-disk-type=pd-standard --tags=gitlab-runner,ssh,http-server,https-server --metadata=enable-oslogin=TRUE --labels=env=production,purpose=gitlab-runner,migrated=true || echo "VM might already exist"
    - sleep 10
    - gcloud compute instances describe $NEW_VM_NAME --zone=$NEW_ZONE --format="table(name,status,networkInterfaces[0].accessConfigs[0].natIP)"
    - echo ""
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "âœ… Phase 2 complete! VM created in $NEW_ZONE"
    - echo ""
    - echo "ğŸ”§ MANUAL STEP - SSH into new VM and register runner:"
    - echo "   gcloud compute ssh $NEW_VM_NAME --zone=$NEW_ZONE"
    - echo ""
    - echo "   sudo gitlab-runner unregister --all-runners"
    - echo "   sudo gitlab-runner register --url https://gitlab.com --token YOUR_TOKEN --description 'Nordic Shell Runner (europe-north1)' --tag-list 'shell,gcp,gcp-shell,nordic,any-runner' --executor shell"
    - echo ""
    - echo "Then run pipeline with MIGRATION_PHASE=switch"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# -----------------------------------------------------------------------------
# Phase 3: Verify new runner works
# -----------------------------------------------------------------------------
migration:switch:
  stage: .pre
  tags: [nordic]
  rules:
    - if: $MIGRATION_PHASE == "switch"
      when: always
    - when: never
  script:
    - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    - echo "â•‘  Phase 3 - Verify new runner                                 â•‘"
    - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "ğŸ‰ This job is running on the NEW runner!"
    - hostname
    - cat /etc/os-release | head -3
    - gitlab-runner --version
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - echo "ğŸ“ VM Location:"
    - curl -s -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/zone | cut -d/ -f4
    - echo ""
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "âœ… Phase 3 complete! New runner is operational!"
    - echo "After 48h observation - Run MIGRATION_PHASE=cleanup"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# -----------------------------------------------------------------------------
# Phase 4: Cleanup old resources
# -----------------------------------------------------------------------------
migration:cleanup:
  stage: .pre
  tags: [nordic]
  rules:
    - if: $MIGRATION_PHASE == "cleanup"
      when: manual
  script:
    - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    - echo "â•‘  Phase 4 - Cleanup old resources                             â•‘"
    - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    - echo "â¹ï¸  Stopping old VM..."
    - gcloud compute instances stop $OLD_VM_NAME --zone=$OLD_ZONE || echo "VM might already be stopped"
    - echo "ğŸ—‘ï¸  Deleting old VM $OLD_VM_NAME..."
    - gcloud compute instances delete $OLD_VM_NAME --zone=$OLD_ZONE --quiet || echo "VM might already be deleted"
    - echo ""
    - echo "ğŸ“¸ Remaining snapshots (delete manually after 7 days):"
    - gcloud compute snapshots list --filter="name~clarissa-runner" --format="table(name,creationTimestamp,diskSizeGb)"
    - echo ""
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "âœ… Migration complete!"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
