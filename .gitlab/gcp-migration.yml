# GCP Nordic Migration Pipeline
# Migriert clarissa-runner von europe-west1-b nach europe-north1-a

variables:
  OLD_ZONE: "europe-west1-b"
  NEW_ZONE: "europe-north1-a"
  OLD_VM_NAME: "clarissa-runner"
  NEW_VM_NAME: "nordic-runner"
  GCP_PROJECT: "myk8sproject-207017"
  MACHINE_TYPE: "e2-micro"
  DISK_SIZE: "30GB"

migration:backup:
  stage: .pre
  tags: [gcp-shell]
  rules:
    - if: $MIGRATION_PHASE == "backup"
      when: always
    - when: never
  script:
    - echo "=== Phase 1 - Backup and Snapshot ==="
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    - echo "Backing up GitLab Runner config..."
    - sudo cat /etc/gitlab-runner/config.toml > runner-config-backup.toml
    - export SNAPSHOT_NAME="clarissa-runner-snapshot-$(date +%Y%m%d-%H%M)"
    - echo "Creating snapshot $SNAPSHOT_NAME..."
    - gcloud compute disks snapshot $OLD_VM_NAME --zone=$OLD_ZONE --snapshot-names=$SNAPSHOT_NAME --description="Pre-migration snapshot"
    - gcloud compute snapshots describe $SNAPSHOT_NAME --format="table(name,status,diskSizeGb)"
    - echo "SNAPSHOT_NAME=$SNAPSHOT_NAME" > migration.env
    - echo "=== Phase 1 complete! Next - MIGRATION_PHASE=create ==="
  artifacts:
    paths:
      - runner-config-backup.toml
      - migration.env
    expire_in: 7 days

migration:create:
  stage: .pre
  tags: [gcp-shell]
  rules:
    - if: $MIGRATION_PHASE == "create"
      when: always
    - when: never
  script:
    - echo "=== Phase 2 - Create VM in europe-north1 ==="
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    - export SNAPSHOT_NAME=$(gcloud compute snapshots list --filter="name~clarissa-runner-snapshot" --sort-by=~creationTimestamp --limit=1 --format="value(name)")
    - echo "Using snapshot $SNAPSHOT_NAME"
    - export IMAGE_NAME="nordic-runner-image-$(date +%Y%m%d)"
    - echo "Creating image $IMAGE_NAME..."
    - gcloud compute images create $IMAGE_NAME --source-snapshot=$SNAPSHOT_NAME --description="Nordic runner image" || echo "Image exists"
    - echo "Creating VM $NEW_VM_NAME in $NEW_ZONE..."
    - gcloud compute instances create $NEW_VM_NAME --zone=$NEW_ZONE --machine-type=$MACHINE_TYPE --image=$IMAGE_NAME --boot-disk-size=$DISK_SIZE --boot-disk-type=pd-standard --tags=gitlab-runner,ssh,http-server,https-server --metadata=enable-oslogin=TRUE --labels=env=production,purpose=gitlab-runner || echo "VM exists"
    - sleep 10
    - gcloud compute instances describe $NEW_VM_NAME --zone=$NEW_ZONE --format="table(name,status,networkInterfaces[0].accessConfigs[0].natIP)"
    - echo "=== Phase 2 complete! ==="
    - echo "MANUAL STEP - SSH and register runner:"
    - echo "  gcloud compute ssh $NEW_VM_NAME --zone=$NEW_ZONE"
    - echo "  sudo gitlab-runner unregister --all-runners"
    - echo "  sudo gitlab-runner register --url https://gitlab.com --token TOKEN --description Nordic-Shell-Runner --tag-list shell,gcp,gcp-shell,nordic,any-runner --executor shell"
    - echo "Then run MIGRATION_PHASE=switch"

migration:switch:
  stage: .pre
  tags: [nordic]
  rules:
    - if: $MIGRATION_PHASE == "switch"
      when: always
    - when: never
  script:
    - echo "=== Phase 3 - Verify new runner ==="
    - echo "Running on NEW runner!"
    - hostname
    - gitlab-runner --version
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - echo "VM Location:"
    - curl -s -H "Metadata-Flavor:Google" http://metadata.google.internal/computeMetadata/v1/instance/zone
    - echo ""
    - echo "=== Phase 3 complete! After 48h run MIGRATION_PHASE=cleanup ==="

migration:cleanup:
  stage: .pre
  tags: [nordic]
  rules:
    - if: $MIGRATION_PHASE == "cleanup"
      when: manual
  script:
    - echo "=== Phase 4 - Cleanup old resources ==="
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    - echo "Stopping old VM..."
    - gcloud compute instances stop $OLD_VM_NAME --zone=$OLD_ZONE || echo "Already stopped"
    - echo "Deleting old VM..."
    - gcloud compute instances delete $OLD_VM_NAME --zone=$OLD_ZONE --quiet || echo "Already deleted"
    - echo "Remaining snapshots:"
    - gcloud compute snapshots list --filter="name~clarissa-runner" --format="table(name,creationTimestamp)"
    - echo "=== Migration complete! ==="
