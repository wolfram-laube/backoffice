# =============================================================================
# GCP Nordic Migration Pipeline
# =============================================================================
# Migriert clarissa-runner von europe-west1-b nach europe-north1-a
#
# Phasen:
#   1. backup    - Snapshot erstellen (automatisch)
#   2. create    - Neue VM erstellen (automatisch)
#   3. register  - Runner registrieren (MANUELL auf neuer VM)
#   4. switch    - CI/CD auf neue Zone umstellen (automatisch)
#   5. cleanup   - Alte VM lÃ¶schen (manuell, nach 48h)
# =============================================================================

variables:
  OLD_ZONE: "europe-west1-b"
  NEW_ZONE: "europe-north1-a"
  OLD_VM_NAME: "clarissa-runner"
  NEW_VM_NAME: "nordic-runner"
  GCP_PROJECT: "myk8sproject-207017"
  MACHINE_TYPE: "e2-micro"
  DISK_SIZE: "30GB"

# -----------------------------------------------------------------------------
# Phase 1: Backup & Snapshot
# -----------------------------------------------------------------------------
migration:backup:
  stage: .pre
  tags: [gcp-shell]
  rules:
    - if: $MIGRATION_PHASE == "backup"
      when: always
    - when: never
  script:
    - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    - echo "â•‘  Phase 1: Backup & Snapshot                                  â•‘"
    - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Authenticate
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    
    # Backup runner config
    - echo "ğŸ“ Backing up GitLab Runner config..."
    - sudo cat /etc/gitlab-runner/config.toml > runner-config-backup.toml
    - echo "   âœ“ Config saved"
    
    # Create snapshot (VM muss NICHT gestoppt werden fÃ¼r Snapshot)
    - SNAPSHOT_NAME="clarissa-runner-snapshot-$(date +%Y%m%d-%H%M)"
    - echo "ğŸ“¸ Creating snapshot $SNAPSHOT_NAME..."
    - |
      gcloud compute disks snapshot $OLD_VM_NAME \n        --zone=$OLD_ZONE \n        --snapshot-names=$SNAPSHOT_NAME \n        --description="Pre-migration snapshot for Nordic migration"
    - echo "   âœ“ Snapshot created"
    
    # Verify
    - echo "âœ… Verifying snapshot..."
    - gcloud compute snapshots describe $SNAPSHOT_NAME --format="table(name,status,diskSizeGb)"
    
    # Save snapshot name for next phase
    - echo "SNAPSHOT_NAME=$SNAPSHOT_NAME" > migration.env
    - echo ""
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "âœ… Phase 1 complete! Snapshot: $SNAPSHOT_NAME"
    - echo ""
    - echo "Next: Run pipeline with MIGRATION_PHASE=create"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  
  artifacts:
    paths:
      - runner-config-backup.toml
      - migration.env
    expire_in: 7 days

# -----------------------------------------------------------------------------
# Phase 2: Create VM in new region
# -----------------------------------------------------------------------------
migration:create:
  stage: .pre
  tags: [gcp-shell]
  rules:
    - if: $MIGRATION_PHASE == "create"
      when: always
    - when: never
  script:
    - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    - echo "â•‘  Phase 2: Create VM in europe-north1                         â•‘"
    - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Authenticate
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    
    # Find latest snapshot
    - |
      SNAPSHOT_NAME=$(gcloud compute snapshots list \n        --filter="name~clarissa-runner-snapshot" \n        --sort-by=~creationTimestamp \n        --limit=1 \n        --format="value(name)")
    - echo "ğŸ“¸ Using snapshot: $SNAPSHOT_NAME"
    
    # Create image from snapshot
    - IMAGE_NAME="nordic-runner-image-$(date +%Y%m%d)"
    - echo "ğŸ–¼ï¸  Creating image $IMAGE_NAME..."
    - |
      gcloud compute images create $IMAGE_NAME \n        --source-snapshot=$SNAPSHOT_NAME \n        --description="Image for Nordic runner migration" \n        || echo "Image might already exist, continuing..."
    
    # Check if VM already exists
    - |
      if gcloud compute instances describe $NEW_VM_NAME --zone=$NEW_ZONE &>/dev/null; then
        echo "âš ï¸  VM $NEW_VM_NAME already exists in $NEW_ZONE"
        gcloud compute instances describe $NEW_VM_NAME --zone=$NEW_ZONE --format="table(name,status,networkInterfaces[0].accessConfigs[0].natIP)"
      else
        echo "ğŸ–¥ï¸  Creating VM $NEW_VM_NAME in $NEW_ZONE..."
        gcloud compute instances create $NEW_VM_NAME \n          --zone=$NEW_ZONE \n          --machine-type=$MACHINE_TYPE \n          --image=$IMAGE_NAME \n          --boot-disk-size=$DISK_SIZE \n          --boot-disk-type=pd-standard \n          --tags=gitlab-runner,ssh,http-server,https-server \n          --metadata=enable-oslogin=TRUE \n          --labels=env=production,purpose=gitlab-runner,migrated=true
        echo "   âœ“ VM created"
      fi
    
    # Wait and get IP
    - sleep 10
    - |
      EXTERNAL_IP=$(gcloud compute instances describe $NEW_VM_NAME \n        --zone=$NEW_ZONE \n        --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
    - echo "   External IP: $EXTERNAL_IP"
    
    - echo ""
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "âœ… Phase 2 complete! VM $NEW_VM_NAME created in $NEW_ZONE"
    - echo ""
    - echo "ğŸ”§ MANUAL STEP REQUIRED:"
    - echo ""
    - echo "   1. SSH into new VM:"
    - echo "      gcloud compute ssh $NEW_VM_NAME --zone=$NEW_ZONE"
    - echo ""
    - echo "   2. Register runner (get token from GitLab UI):"
    - echo "      sudo gitlab-runner unregister --all-runners"
    - echo "      sudo gitlab-runner register \"
    - echo "        --url https://gitlab.com \"
    - echo "        --token YOUR_RUNNER_TOKEN \"
    - echo "        --description 'Nordic Shell Runner (europe-north1)' \"
    - echo "        --tag-list 'shell,gcp,gcp-shell,nordic,any-runner' \"
    - echo "        --executor shell"
    - echo ""
    - echo "   3. Verify runner is online in GitLab"
    - echo ""
    - echo "   4. Run pipeline with MIGRATION_PHASE=switch"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# -----------------------------------------------------------------------------
# Phase 3: Switch CI/CD to new zone (runs on NEW runner)
# -----------------------------------------------------------------------------
migration:switch:
  stage: .pre
  tags: [nordic]  # <-- Runs on NEW runner!
  rules:
    - if: $MIGRATION_PHASE == "switch"
      when: always
    - when: never
  script:
    - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    - echo "â•‘  Phase 3: Verify new runner works                            â•‘"
    - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - echo "ğŸ‰ This job is running on the NEW runner!"
    - echo ""
    - hostname
    - cat /etc/os-release | head -3
    - gitlab-runner --version
    - echo ""
    
    # Authenticate and verify
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    
    - echo "ğŸ“ VM Location:"
    - curl -s -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/zone | cut -d/ -f4
    
    - echo ""
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "âœ… Phase 3 complete! New runner is operational!"
    - echo ""
    - echo "Next steps:"
    - echo "  1. Update CI/CD files (europe-west1-b â†’ europe-north1-a)"
    - echo "  2. Test a few pipelines on the new runner"
    - echo "  3. After 48h: Run pipeline with MIGRATION_PHASE=cleanup"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# -----------------------------------------------------------------------------
# Phase 4: Cleanup old resources (after 48h observation)
# -----------------------------------------------------------------------------
migration:cleanup:
  stage: .pre
  tags: [nordic]  # <-- Runs on NEW runner!
  rules:
    - if: $MIGRATION_PHASE == "cleanup"
      when: manual  # Requires manual confirmation!
  script:
    - echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    - echo "â•‘  Phase 4: Cleanup old resources                              â•‘"
    - echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Authenticate
    - echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT
    
    # Stop old VM first (safer than delete)
    - echo "â¹ï¸  Stopping old VM..."
    - gcloud compute instances stop $OLD_VM_NAME --zone=$OLD_ZONE || echo "VM might already be stopped"
    
    # Delete old VM
    - echo "ğŸ—‘ï¸  Deleting old VM $OLD_VM_NAME..."
    - gcloud compute instances delete $OLD_VM_NAME --zone=$OLD_ZONE --quiet || echo "VM might already be deleted"
    
    # List remaining snapshots (don't delete yet - keep as backup)
    - echo ""
    - echo "ğŸ“¸ Remaining snapshots (delete manually after 7 days):"
    - gcloud compute snapshots list --filter="name~clarissa-runner" --format="table(name,creationTimestamp,diskSizeGb)"
    
    - echo ""
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - echo "âœ… Migration complete!"
    - echo ""
    - echo "Old VM deleted. Snapshots kept as backup."
    - echo "Delete snapshots manually after 7 days:"
    - echo "  gcloud compute snapshots delete SNAPSHOT_NAME"
    - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"