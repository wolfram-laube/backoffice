# =============================================================================
# BLAUWEISS BACKOFFICE - Pages Deployment
# =============================================================================
# MkDocs Operations Portal
# =============================================================================

# -----------------------------------------------------------------------------
# NAV CHECK: Validate mkdocs.yml navigation
# -----------------------------------------------------------------------------
mkdocs_nav_check:
  stage: validate
  image: python:3.11-slim
  tags:
    - gitlab-org-docker
  script:
    - pip install pyyaml
    - python -c "
import yaml
with open('mkdocs.yml') as f:
    config = yaml.safe_load(f)
nav = config.get('nav', [])
print(f'âœ… Navigation has {len(nav)} sections')
for section in nav:
    if isinstance(section, dict):
        for k, v in section.items():
            print(f'   - {k}')
    else:
        print(f'   - {section}')
"
  rules:
    - changes:
        - mkdocs.yml
        - docs/**/*
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# -----------------------------------------------------------------------------
# PAGES: Deploy MkDocs site
# -----------------------------------------------------------------------------
pages:
  stage: deploy
  image: python:3.11-slim
  tags:
    - gitlab-org-docker
  variables:
    ENABLE_PDF_EXPORT: "0"
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git
    - pip install --upgrade pip
    - pip install mkdocs mkdocs-material mkdocs-jupyter pymdown-extensions
  script:
    - echo "ðŸš€ Building Operations Portal..."
    - mkdocs build --strict
    - echo "âœ… Portal built successfully"
    
    # Create redirects for old URLs
    - |
      cat > public/_redirects << 'EOF'
      /portal.html /portal.html 200
      /ops/* /ops/:splat 200
      /triggers/* /triggers/:splat 200
      EOF
    
    # Health check file
    - echo "OK - $(date -u +%Y-%m-%dT%H:%M:%SZ)" > public/health.txt
    
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  environment:
    name: production
    url: https://wolfram_laube.gitlab.io/blauweiss_llc/ops/backoffice/

# -----------------------------------------------------------------------------
# REBUILD: Manual trigger for docs rebuild
# -----------------------------------------------------------------------------
rebuild_docs:
  stage: deploy
  image: python:3.11-slim
  tags:
    - gitlab-org-docker
  script:
    - pip install mkdocs mkdocs-material mkdocs-jupyter pymdown-extensions
    - mkdocs build --strict
    - echo "âœ… Docs rebuilt"
  artifacts:
    paths:
      - public
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
  environment:
    name: production
    url: https://wolfram_laube.gitlab.io/blauweiss_llc/ops/backoffice/

# -----------------------------------------------------------------------------
# PREVIEW: MR preview deployment
# -----------------------------------------------------------------------------
docs:preview:
  stage: deploy
  image: python:3.11-slim
  tags:
    - gitlab-org-docker
  script:
    - pip install mkdocs mkdocs-material mkdocs-jupyter pymdown-extensions
    - mkdocs build
    - echo "Preview built for MR !${CI_MERGE_REQUEST_IID}"
  artifacts:
    paths:
      - public
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - mkdocs.yml
        - docs/**/*
  environment:
    name: preview/$CI_MERGE_REQUEST_IID
    url: https://wolfram_laube.gitlab.io/blauweiss_llc/ops/backoffice/
    auto_stop_in: 1 week
