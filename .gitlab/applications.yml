# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  APPLICATIONS PIPELINE - Automated Job Hunting
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
#  TÃ¤glich um 08:00 Uhr:
#  1. Crawlt freelancermap.de nach neuen Projekten
#  2. Matcht gegen Profile (Wolfram, Ian, Michael, Teams)
#  3. QA: Validiert Outputs + CRM-Duplikatcheck
#  4. Erstellt Gmail-Drafts mit Attachments
#
#  Setup:
#  â”€â”€â”€â”€â”€â”€
#  1. Schedule in GitLab: CI/CD â†’ Schedules â†’ "0 8 * * 1-5"
#  2. Variable: GMAIL_REFRESH_TOKEN (masked)
#
#  Runners:
#  â”€â”€â”€â”€â”€â”€â”€â”€
#  Primary:  docker-any (python:3.11-slim) â€” immer verfÃ¼gbar
#  Fallback: mac-group-shell â€” wenn Mac online
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Shared config for all application jobs
.applications-base:
  # image: python:3.11-slim  # Shell runner
  tags:
    - shell
  before_script:
    - pip install requests beautifulsoup4 lxml pyyaml --quiet

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  STAGE 1: CRAWL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:crawl:
  extends: .applications-base
  needs: []
  stage: .pre
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPLICATIONS_CRAWL == "true"
    - if: $APPLICATIONS_CRAWL == "true"
    - when: manual
      allow_failure: true
  variables:
    KEYWORDS: "DevOps Kubernetes,Python Cloud,AI ML LLM,Java Spring Architekt,MLOps Platform"
    MIN_REMOTE: "50"
    MAX_PAGES: "3"
  script:
    - python3 scripts/ci/applications_crawl.py
  artifacts:
    paths:
      - output/projects.json
    expire_in: 7 days

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  STAGE 2: MATCH
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:match:
  extends: .applications-base
  stage: build
  needs:
    - job: applications:crawl
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: $APPLICATIONS_MATCH == "true"
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPLICATIONS_MATCH == "true"
    - when: manual
      allow_failure: true
  variables:
    MIN_SCORE: "50"
    MAX_RESULTS: "20"
  script:
    - python3 scripts/ci/applications_match.py
  artifacts:
    paths:
      - output/matches.json
    expire_in: 7 days

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  STAGE 3: QA VALIDATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:qa:
  extends: .applications-base
  stage: test
  needs:
    - job: applications:crawl
      artifacts: true
    - job: applications:match
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: $APPLICATIONS_QA == "true"
    - if: $APPLICATIONS_CRAWL == "true"
    - if: $APPLICATIONS_MATCH == "true"
    - when: manual
      allow_failure: true
  variables:
    CRM_PROJECT_ID: "78171527"
  script:
    - python3 scripts/ci/applications_qa.py --crm-dedup
  artifacts:
    paths:
      - output/qa_report.json
    expire_in: 7 days
    reports:
      junit: output/qa_report.json
  allow_failure:
    exit_codes:
      - 2  # Warnings don't block, only failures (exit 1)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  STAGE 3.5: VORHÃ–LLE â€” Match Staging
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
#  Stages qualified matches (â‰¥70%) as GitLab Issues for review.
#  Two modes:
#    - SERVICE: POST to VorhÃ¶lle Cloud Run service (if STAGING_SERVICE_URL set)
#    - DIRECT:  Create GitLab Issues via API (default)
#
#  Review workflow: pending â†’ approved â†’ drafts
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:stage:
  extends: .applications-base
  stage: test
  needs:
    - job: applications:match
      artifacts: true
    - job: applications:qa
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: $APPLICATIONS_STAGE == "true"
    - when: manual
      allow_failure: true
  variables:
    STAGING_MIN_SCORE: "70"
    STAGING_PROFILE: "wolfram"
    STAGING_ASSIGNEE_ID: "1349601"
    # STAGING_SERVICE_URL: "https://match-staging-....run.app"  # Enable when deployed
  script:
    - python3 scripts/ci/applications_stage.py
  artifacts:
    paths:
      - output/staged.json
    expire_in: 7 days

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  STAGE 4: CREATE GMAIL DRAFTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:drafts:
  extends: .applications-base
  stage: deploy
  needs:
    - job: applications:match
      artifacts: true
    - job: applications:qa
      artifacts: true
    - job: applications:stage
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: $APPLICATIONS_DRAFTS == "true"
    - when: manual
      allow_failure: true
  variables:
    MAX_DRAFTS: "5"
  script:
    - python3 scripts/ci/applications_drafts.py

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  CRM INTEGRITY CHECK (standalone, weekly schedule)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

crm:integrity-check:
  extends: .applications-base
  needs: []
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CRM_INTEGRITY_CHECK == "true"
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $CRM_INTEGRITY_CHECK == "true"
    - if: $CRM_QA == "true"
    - when: manual
      allow_failure: true
  variables:
    CRM_PROJECT_ID: "78171527"
    GROUP_ID: "120698013"
  script:
    - python3 scripts/ci/crm_integrity_check.py
  artifacts:
    paths:
      - output/crm_qa_report.json
    expire_in: 30 days


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  STAGE 5: CRM SYNC (after drafts)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:crm-sync:
  extends: .applications-base
  stage: deploy
  needs:
    - job: applications:drafts
      artifacts: true
      optional: true
    - job: applications:match
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: $APPLICATIONS_CRM_SYNC == "true"
    - when: manual
      allow_failure: true
  variables:
    CRM_PROJECT_ID: "78171527"
    GITLAB_TOKEN: $GITLAB_API_TOKEN
  script:
    - python3 scripts/ci/crm_update_on_draft.py
  artifacts:
    paths:
      - output/crm_update_results.json
    expire_in: 7 days


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  CRM REPORTING (Phase 5)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

crm:report-weekly:
  extends: .applications-base
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CRM_REPORT_WEEKLY == "true"
    - if: $CRM_REPORT == "weekly"
    - when: manual
      allow_failure: true
  variables:
    CRM_PROJECT_ID: "78171527"
    GITLAB_TOKEN: $GITLAB_API_TOKEN
    REPORT_TYPE: "weekly"
  script:
    - python3 scripts/ci/crm_reporting.py
  artifacts:
    paths:
      - output/crm_report_weekly.md
      - output/crm_report_weekly.json
    expire_in: 90 days

crm:report-monthly:
  extends: .applications-base
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $CRM_REPORT_MONTHLY == "true"
    - if: $CRM_REPORT == "monthly"
    - when: manual
      allow_failure: true
  variables:
    CRM_PROJECT_ID: "78171527"
    GITLAB_TOKEN: $GITLAB_API_TOKEN
    REPORT_TYPE: "monthly"
  script:
    - python3 scripts/ci/crm_reporting.py
  artifacts:
    paths:
      - output/crm_report_monthly.md
      - output/crm_report_monthly.json
    expire_in: 365 days

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  MANUAL: DRY RUN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:dry-run:
  extends: .applications-base
  stage: .pre
  rules:
    - when: manual
  script:
    - echo "ğŸ” DRY RUN - Testing pipeline..."
    - echo "1. Would crawl - DevOps, Python, AI, Java"
    - echo "2. Would match against - Wolfram, Ian, Michael, Teams"
    - echo "3. Would QA-validate outputs + CRM dedup"
    - echo "4. Would create Gmail drafts"
    - echo ""
    - echo "To run for real:"
    - echo "  â†’ Set APPLICATIONS_PIPELINE=true in schedule"
    - echo "  â†’ Or trigger individual jobs manually"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  APPTRACK: CSV â†’ SQLite IMPORT (one-time + on CSV updates)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:import-csv:
  extends: .applications-base
  needs: []
  stage: build
  rules:
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPLICATIONS_IMPORT_CSV == "true"
    - when: manual
      allow_failure: true
  variables:
    APPTRACK_DB_PATH: "/tmp/applications.db"
  before_script:
    - pip install sqlalchemy google-cloud-storage --quiet
  script:
    - python3 scripts/ci/applications_import_csv.py --csv data/bewerbungen_komplett_SORTED_Jan_31_2026.csv --db $APPTRACK_DB_PATH -v
    - |
      python3 -c "
      import os, sys
      sys.path.insert(0, '.')
      from modules.applications.database import upload_db
      from pathlib import Path
      ok = upload_db(Path(os.environ['APPTRACK_DB_PATH']))
      sys.exit(0 if ok else 1)
      "


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  APPTRACK: EXPORT (JSON for Pages + CSV fallback)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:export:
  extends: .applications-base
  needs: []
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_EXPORT == "true"
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPLICATIONS_EXPORT == "true"
    - when: manual
      allow_failure: true
  before_script:
    - pip install sqlalchemy google-cloud-storage --quiet
  script:
    - python3 scripts/ci/applications_export_json.py --gcs --json-dir public --csv-dir output -v
  artifacts:
    paths:
      - public/dashboard.json
      - output/bewerbungen_export.csv
    expire_in: 30 days


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  APPTRACK: TESTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:test:
  extends: .applications-base
  needs: []
  stage: test
  rules:
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPLICATIONS_TEST == "true"
    - changes:
        - modules/applications/**/*
        - scripts/ci/applications_import_csv.py
        - scripts/ci/applications_export_json.py
        - tests/unit/test_applications.py
    - when: manual
      allow_failure: true
  before_script:
    - pip install sqlalchemy pytest --quiet
  script:
    - python3 -m pytest tests/unit/test_applications.py -v --tb=short


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  APPTRACK: CRAWL â†’ DB INTEGRATION (Sprint 2)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
#  Wires crawl pipeline output into AppTrack SQLite/GCS database:
#    crawl output â†’ crawl_results table â†’ match scores â†’ Application records
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

apptrack:ingest-crawl:
  extends: .applications-base
  stage: build
  needs:
    - job: applications:crawl
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPTRACK_INGEST == "true"
    - when: manual
      allow_failure: true
  before_script:
    - pip install sqlalchemy google-cloud-storage --quiet
  script:
    - python3 scripts/ci/apptrack_ingest_crawl.py -v


apptrack:update-matches:
  extends: .applications-base
  stage: test
  needs:
    - job: apptrack:ingest-crawl
    - job: applications:match
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPTRACK_MATCH == "true"
    - when: manual
      allow_failure: true
  before_script:
    - pip install sqlalchemy google-cloud-storage --quiet
  script:
    - python3 scripts/ci/apptrack_update_matches.py --profile wolfram -v



# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  APPTRACK: VORHÃ–LLE REVIEW PROMOTION (Sprint 4)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

apptrack:promote-review:
  extends: .applications-base
  stage: test
  needs:
    - job: apptrack:update-matches
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPTRACK_REVIEW == "true"
    - when: manual
      allow_failure: true
  before_script:
    - pip install sqlalchemy google-cloud-storage --quiet
  script:
    - python3 scripts/ci/apptrack_promote_review.py --min-score 70 --notify -v
  artifacts:
    paths:
      - output/apptrack_review_queue.json
    expire_in: 7 days


apptrack:stage-approved:
  extends: .applications-base
  stage: deploy
  needs:
    - job: apptrack:promote-review
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPTRACK_STAGE == "true"
    - when: manual
      allow_failure: true
  variables:
    CRM_PROJECT_ID: "78171527"
  before_script:
    - pip install sqlalchemy google-cloud-storage requests --quiet
  script:
    - python3 scripts/ci/apptrack_stage_approved.py --min-score 70 -v
  artifacts:
    paths:
      - output/apptrack_stage_results.json
    expire_in: 7 days


apptrack:test:
  extends: .applications-base
  needs: []
  stage: test
  rules:
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPLICATIONS_TEST == "true"
    - changes:
        - modules/applications/**/*
        - scripts/ci/apptrack_*.py
        - tests/unit/test_crawl_service.py
        - tests/unit/test_review_service.py
        - modules/applications/review_service.py
    - when: manual
      allow_failure: true
  before_script:
    - pip install sqlalchemy pytest --quiet
  script:
    - python3 -m pytest tests/unit/test_crawl_service.py tests/unit/test_review_service.py -v --tb=short


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  APPTRACK: DASHBOARD DATA TESTS (Sprint 3)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

apptrack:dashboard-test:
  extends: .applications-base
  needs: []
  stage: test
  rules:
    - if: ($CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "api") && $APPLICATIONS_TEST == "true"
    - changes:
        - docs/apptrack-dashboard.html
        - tests/unit/test_dashboard_data.py
        - scripts/ci/applications_export_json.py
    - when: manual
      allow_failure: true
  before_script:
    - pip install sqlalchemy pytest --quiet
  script:
    - python3 -m pytest tests/unit/test_dashboard_data.py -v --tb=short
