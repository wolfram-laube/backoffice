<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š AppTrack Dashboard â€” Blauweiss Operations</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f0f1a;
            --surface: #1a1a2e;
            --surface2: #252542;
            --surface3: #2f2f52;
            --text: #e4e4f0;
            --subtext: #9090a8;
            --accent: #6c5ce7;
            --green: #00cec9;
            --yellow: #fdcb6e;
            --red: #ff7675;
            --blue: #74b9ff;
            --purple: #a29bfe;
            --orange: #e17055;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        header {
            text-align: center;
            padding: 30px 0 20px;
            border-bottom: 1px solid var(--surface2);
            margin-bottom: 24px;
        }
        header h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        header .subtitle { color: var(--subtext); margin-top: 6px; font-size: 0.95rem; }
        .meta-row {
            display: flex; justify-content: center; align-items: center;
            gap: 20px; margin-top: 12px; flex-wrap: wrap;
        }
        .meta-badge {
            background: var(--surface2); color: var(--subtext);
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem;
        }
        .meta-badge.live { color: var(--green); }

        /* â”€â”€ Controls Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .controls {
            display: flex; gap: 12px; margin-bottom: 20px;
            flex-wrap: wrap; align-items: center;
        }
        .search-box {
            flex: 1; min-width: 220px;
            background: var(--surface); border: 1px solid var(--surface2);
            border-radius: 10px; padding: 10px 14px;
            color: var(--text); font-size: 0.9rem;
            outline: none; transition: border-color 0.2s;
        }
        .search-box:focus { border-color: var(--accent); }
        .search-box::placeholder { color: var(--subtext); }
        select.filter {
            background: var(--surface); border: 1px solid var(--surface2);
            border-radius: 10px; padding: 10px 14px;
            color: var(--text); font-size: 0.9rem;
            cursor: pointer; outline: none;
        }
        select.filter:focus { border-color: var(--accent); }
        .btn {
            background: var(--accent); color: white; border: none;
            border-radius: 10px; padding: 10px 18px;
            font-size: 0.9rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            transition: background 0.2s, transform 0.15s;
        }
        .btn:hover { background: #5b4bd5; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn.secondary {
            background: var(--surface2); color: var(--text);
        }
        .btn.secondary:hover { background: var(--surface3); }

        /* â”€â”€ Stats Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px; margin-bottom: 24px;
        }
        .stat-card {
            background: var(--surface); border: 1px solid var(--surface2);
            border-radius: 14px; padding: 18px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(108, 92, 231, 0.12);
        }
        .stat-card .value {
            font-size: 2rem; font-weight: 700;
            margin-bottom: 4px;
        }
        .stat-card .label {
            color: var(--subtext); font-size: 0.82rem;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .stat-card.accent .value { color: var(--accent); }
        .stat-card.green .value { color: var(--green); }
        .stat-card.yellow .value { color: var(--yellow); }
        .stat-card.red .value { color: var(--red); }
        .stat-card.blue .value { color: var(--blue); }
        .stat-card.purple .value { color: var(--purple); }

        /* â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px; margin-bottom: 24px;
        }
        .chart-card {
            background: var(--surface); border: 1px solid var(--surface2);
            border-radius: 14px; padding: 20px;
        }
        .chart-card h3 {
            font-size: 1rem; margin-bottom: 14px;
            color: var(--text); display: flex; align-items: center; gap: 8px;
        }
        .chart-wrap { position: relative; width: 100%; }
        .chart-wrap.pie { max-width: 300px; margin: 0 auto; }

        /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .table-card {
            background: var(--surface); border: 1px solid var(--surface2);
            border-radius: 14px; overflow: hidden;
        }
        .table-card h3 {
            padding: 16px 20px 12px; font-size: 1rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        .table-card h3 .count { color: var(--subtext); font-weight: 400; font-size: 0.85rem; }
        .table-wrap { overflow-x: auto; }
        table {
            width: 100%; border-collapse: collapse; font-size: 0.85rem;
        }
        thead th {
            background: var(--surface2); color: var(--subtext);
            padding: 10px 14px; text-align: left; white-space: nowrap;
            cursor: pointer; user-select: none;
            text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px;
        }
        thead th:hover { color: var(--text); }
        thead th .sort-arrow { margin-left: 4px; opacity: 0.4; }
        thead th.sorted .sort-arrow { opacity: 1; color: var(--accent); }
        tbody tr {
            border-bottom: 1px solid var(--surface2);
            transition: background 0.15s;
        }
        tbody tr:hover { background: rgba(108, 92, 231, 0.06); }
        tbody td { padding: 10px 14px; white-space: nowrap; }
        tbody td.wrap { white-space: normal; max-width: 300px; }

        /* Status badges */
        .status {
            display: inline-block; padding: 3px 10px;
            border-radius: 20px; font-size: 0.78rem; font-weight: 500;
        }
        .status.versendet { background: rgba(116, 185, 255, 0.15); color: var(--blue); }
        .status.abgelehnt { background: rgba(255, 118, 117, 0.15); color: var(--red); }
        .status.in_kontakt { background: rgba(0, 206, 201, 0.15); color: var(--green); }
        .status.verhandlung { background: rgba(253, 203, 110, 0.15); color: var(--yellow); }
        .status.nicht_beworben { background: rgba(144, 144, 168, 0.15); color: var(--subtext); }
        .status.sonstige { background: rgba(162, 155, 254, 0.15); color: var(--purple); }

        /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        footer {
            text-align: center; padding: 24px 0 12px;
            color: var(--subtext); font-size: 0.8rem;
            border-top: 1px solid var(--surface2); margin-top: 30px;
        }
        footer a { color: var(--accent); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* â”€â”€ Loading / Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading {
            text-align: center; padding: 60px 20px;
            color: var(--subtext); font-size: 1.1rem;
        }
        .loading .spinner {
            width: 40px; height: 40px; margin: 0 auto 16px;
            border: 3px solid var(--surface2); border-top: 3px solid var(--accent);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg {
            background: rgba(255, 118, 117, 0.1); border: 1px solid rgba(255, 118, 117, 0.3);
            border-radius: 12px; padding: 20px; color: var(--red);
            text-align: center; margin: 20px 0;
        }

        /* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 8px; padding: 16px; color: var(--subtext); font-size: 0.85rem;
        }
        .pagination button {
            background: var(--surface2); border: none; color: var(--text);
            padding: 6px 12px; border-radius: 6px; cursor: pointer;
            font-size: 0.85rem;
        }
        .pagination button:hover { background: var(--surface3); }
        .pagination button:disabled { opacity: 0.3; cursor: default; }

        /* â”€â”€ Pipeline Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 100;
            justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--surface); border: 1px solid var(--surface2);
            border-radius: 16px; padding: 28px; max-width: 480px; width: 90%;
        }
        .modal h3 { margin-bottom: 12px; }
        .modal p { color: var(--subtext); margin-bottom: 16px; font-size: 0.9rem; line-height: 1.5; }
        .modal .btn-row { display: flex; gap: 10px; justify-content: flex-end; }
        .modal input {
            width: 100%; background: var(--bg); border: 1px solid var(--surface2);
            border-radius: 8px; padding: 10px 14px; color: var(--text);
            font-size: 0.9rem; margin-bottom: 12px; outline: none;
        }
        .modal input:focus { border-color: var(--accent); }
        .modal .result {
            margin-top: 12px; padding: 10px; border-radius: 8px;
            font-size: 0.85rem; display: none;
        }
        .modal .result.ok { background: rgba(0, 206, 201, 0.1); color: var(--green); display: block; }
        .modal .result.err { background: rgba(255, 118, 117, 0.1); color: var(--red); display: block; }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            header h1 { font-size: 1.6rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
            .search-box { min-width: unset; }
        }

        /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tab-bar {
            display: flex; gap: 0; margin-bottom: 20px;
            border-bottom: 2px solid var(--surface2);
        }
        .tab-btn {
            padding: 12px 24px; cursor: pointer;
            background: none; border: none; color: var(--subtext);
            font-size: 0.95rem; font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px; transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active {
            color: var(--accent); border-bottom-color: var(--accent);
        }
        .tab-btn .badge {
            background: var(--accent); color: white;
            padding: 1px 8px; border-radius: 12px;
            font-size: 0.75rem; margin-left: 6px;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* â”€â”€ Review Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .review-card {
            background: var(--surface); border-radius: 12px;
            padding: 16px 20px; margin-bottom: 12px;
            border: 1px solid var(--surface2);
            transition: border-color 0.2s;
        }
        .review-card:hover { border-color: var(--accent); }
        .review-header {
            display: flex; justify-content: space-between;
            align-items: flex-start; gap: 12px; margin-bottom: 8px;
        }
        .review-title { font-weight: 600; font-size: 1rem; flex: 1; }
        .review-score {
            font-size: 1.1rem; font-weight: 700;
            padding: 2px 10px; border-radius: 8px;
        }
        .review-score.high { background: rgba(0,206,201,0.15); color: var(--green); }
        .review-score.mid { background: rgba(253,203,110,0.15); color: var(--yellow); }
        .review-meta {
            display: flex; gap: 16px; flex-wrap: wrap;
            color: var(--subtext); font-size: 0.85rem; margin-bottom: 10px;
        }
        .review-meta span { display: flex; align-items: center; gap: 4px; }
        .review-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
        .review-tag {
            background: var(--surface2); color: var(--subtext);
            padding: 2px 8px; border-radius: 6px; font-size: 0.75rem;
        }
        .review-tag.ai { background: rgba(108,92,231,0.2); color: var(--purple); }
        .review-actions { display: flex; gap: 8px; }
        .review-actions .btn { font-size: 0.85rem; padding: 6px 16px; }
        .review-actions .btn.approve { background: var(--green); color: #0f0f1a; }
        .review-actions .btn.dismiss { background: var(--surface2); color: var(--subtext); }
        .review-empty {
            text-align: center; padding: 60px 20px; color: var(--subtext);
        }
        .review-empty .icon { font-size: 3rem; margin-bottom: 12px; }
        .review-summary-bar {
            display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .review-summary-item {
            background: var(--surface); border-radius: 10px;
            padding: 12px 20px; flex: 1; min-width: 150px;
        }
        .review-summary-item .label { color: var(--subtext); font-size: 0.8rem; }
        .review-summary-item .value { font-size: 1.4rem; font-weight: 700; }
    </style>
</head>
<body>
<div class="container">

    <!-- Header -->
    <header>
        <h1>ğŸ“Š AppTrack Dashboard</h1>
        <div class="subtitle">Bewerbungs-Tracking â€” Blauweiss Operations</div>
        <div class="meta-row">
            <span class="meta-badge" id="metaGenerated">â³ Lade...</span>
            <span class="meta-badge" id="metaTotal">â€”</span>
            <span class="meta-badge" id="metaCrawl">â€”</span>
        </div>
    </header>

    <!-- Loading state -->
    <div class="loading" id="loadingState">
        <div class="spinner"></div>
        <div>Dashboard-Daten werden geladenâ€¦</div>
    </div>

    <!-- Main content (hidden until loaded) -->
    <div id="mainContent" style="display: none;">


        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('applications')">
                ğŸ“‹ Bewerbungen
            </button>
            <button class="tab-btn" onclick="switchTab('review')">
                ğŸ”¥ VorhÃ¶lle <span class="badge" id="reviewBadge" style="display:none">0</span>
            </button>
        </div>

        <!-- Tab: Applications -->
        <div class="tab-panel active" id="tab-applications">
        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid"></div>

        <!-- Controls -->
        <div class="controls">
            <input type="text" class="search-box" id="searchInput"
                   placeholder="ğŸ” Suche nach Projekt, Provider, Ortâ€¦">
            <select class="filter" id="statusFilter">
                <option value="">Alle Status</option>
                <option value="versendet">ğŸ“¤ Versendet</option>
                <option value="abgelehnt">âŒ Abgelehnt</option>
                <option value="in_kontakt">ğŸ¤ In Kontakt</option>
                <option value="verhandlung">ğŸ’° Verhandlung</option>
                <option value="nicht_beworben">â¸ï¸ Nicht beworben</option>
                <option value="sonstige">ğŸ“‹ Sonstige</option>
            </select>
            <select class="filter" id="monthFilter">
                <option value="">Alle Monate</option>
            </select>
            <button class="btn secondary" onclick="resetFilters()">â†» Reset</button>
            <button class="btn" onclick="openPipelineModal()">ğŸš€ Pipeline</button>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>ğŸ“Š Status-Verteilung</h3>
                <div class="chart-wrap pie">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>ğŸ“ˆ Bewerbungen pro Monat</h3>
                <div class="chart-wrap">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>ğŸ¢ Top Provider</h3>
                <div class="chart-wrap">
                    <canvas id="providerChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>ğŸ’¶ Stundensatz-Verteilung</h3>
                <div class="chart-wrap">
                    <canvas id="rateChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="table-card">
            <h3>
                ğŸ“‹ Bewerbungen
                <span class="count" id="tableCount"></span>
            </h3>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th data-sort="date_recorded" class="sorted">Datum <span class="sort-arrow">â–¼</span></th>
                            <th data-sort="project_title">Projekt <span class="sort-arrow">â–¼</span></th>
                            <th data-sort="provider">Provider <span class="sort-arrow">â–¼</span></th>
                            <th data-sort="location">Ort <span class="sort-arrow">â–¼</span></th>
                            <th data-sort="rate_eur_h">â‚¬/h <span class="sort-arrow">â–¼</span></th>
                            <th data-sort="match_score">Match <span class="sort-arrow">â–¼</span></th>
                            <th data-sort="status">Status <span class="sort-arrow">â–¼</span></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
        </div><!-- /tab-applications -->

        <!-- Tab: Review Queue (VorhÃ¶lle) -->
        <div class="tab-panel" id="tab-review">
            <div class="review-summary-bar" id="reviewSummary"></div>
            <div id="reviewQueue">
                <div class="review-empty">
                    <div class="icon">ğŸ”¥</div>
                    <div>VorhÃ¶lle ist leer â€” keine Matches pending.</div>
                    <div style="margin-top:8px; font-size:0.85rem">
                        Starte die Pipeline um neue Matches zu promoten.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Trigger Modal -->
    <div class="modal-overlay" id="pipelineModal">
        <div class="modal">
            <h3>ğŸš€ Pipeline triggern</h3>
            <p>Startet die Applications-Pipeline: Crawl â†’ Match â†’ Ingest â†’ Stage.
               BenÃ¶tigt einen GitLab Personal Access Token mit <code>api</code> Scope.</p>
            <input type="password" id="pipelineToken" placeholder="GitLab PAT (glpat-â€¦)">
            <div class="btn-row">
                <button class="btn secondary" onclick="closePipelineModal()">Abbrechen</button>
                <button class="btn" onclick="triggerPipeline()" id="triggerBtn">ğŸš€ Starten</button>
            </div>
            <div class="result" id="pipelineResult"></div>
        </div>
    </div>

    <footer>
        <a href="portal.html">â† Portal</a> Â· AppTrack Sprint 3 Â·
        <a href="https://gitlab.com/wolfram_laube/blauweiss_llc/ops/backoffice/-/issues/52" target="_blank">Epic #52</a>
    </footer>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AppTrack Dashboard â€” Frontend Logic
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const PROJECT_ID = 77555895;
const PAGE_SIZE = 25;
let dashboardData = null;
let filteredApps = [];
let currentPage = 0;
let sortColumn = 'date_recorded';
let sortAsc = false;
let charts = {};

/* â”€â”€ Status classification (mirrors export script) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function classifyStatus(raw) {
    if (!raw) return 'sonstige';
    const s = raw.toLowerCase();
    if (s.includes('versendet')) return 'versendet';
    if (s.includes('abgelehnt') || s.includes('absage')) return 'abgelehnt';
    if (s.includes('interview') || s.includes('telefonat') || s.includes('vorgestellt')) return 'in_kontakt';
    if (s.includes('verhandlung') || s.includes('vertrag')) return 'verhandlung';
    if (s.includes('nicht beworben')) return 'nicht_beworben';
    return 'sonstige';
}

const STATUS_LABELS = {
    versendet: 'ğŸ“¤ Versendet',
    abgelehnt: 'âŒ Abgelehnt',
    in_kontakt: 'ğŸ¤ In Kontakt',
    verhandlung: 'ğŸ’° Verhandlung',
    nicht_beworben: 'â¸ï¸ Nicht beworben',
    sonstige: 'ğŸ“‹ Sonstige',
};

const STATUS_COLORS = {
    versendet: '#74b9ff',
    abgelehnt: '#ff7675',
    in_kontakt: '#00cec9',
    verhandlung: '#fdcb6e',
    nicht_beworben: '#9090a8',
    sonstige: '#a29bfe',
};

/* â”€â”€ Load Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadDashboard() {
    try {
        /* Try relative path first (GitLab Pages), then fallback */
        let resp;
        const paths = ['dashboard.json', '../dashboard.json', '/dashboard.json'];
        for (const path of paths) {
            try {
                resp = await fetch(path);
                if (resp.ok) break;
            } catch (e) { /* try next */ }
        }
        if (!resp || !resp.ok) throw new Error('dashboard.json nicht gefunden');
    window._dashboardData = null;

        dashboardData = await resp.json();
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        renderMeta();
        renderStats();
        populateMonthFilter();
        applyFilters();
        renderCharts();
    } catch (err) {
        document.getElementById('loadingState').innerHTML =
            `<div class="error-msg">âŒ Fehler: ${err.message}<br>
             <small>Stelle sicher, dass <code>applications:export</code> gelaufen ist.</small></div>`;
    }
}

/* â”€â”€ Meta badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderMeta() {
    const d = dashboardData;
    const gen = d.generated_at ? new Date(d.generated_at) : null;
    document.getElementById('metaGenerated').textContent =
        gen ? `Stand: ${gen.toLocaleDateString('de-DE')} ${gen.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})}` : 'â€”';
    document.getElementById('metaGenerated').classList.add('live');
    document.getElementById('metaTotal').textContent = `${d.statistics?.total || 0} Bewerbungen`;
    document.getElementById('metaCrawl').textContent =
        `ğŸ•·ï¸ ${d.crawl_summary?.total || 0} gecrawlt (${d.crawl_summary?.new || 0} neu)`;
}

/* â”€â”€ Stats Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderStats() {
    const s = dashboardData.statistics;
    const grid = document.getElementById('statsGrid');
    const cards = [
        { value: s.total, label: 'Gesamt', cls: 'accent' },
        { value: s.status_distribution?.versendet || 0, label: 'Versendet', cls: 'blue' },
        { value: s.status_distribution?.in_kontakt || 0, label: 'In Kontakt', cls: 'green' },
        { value: s.status_distribution?.abgelehnt || 0, label: 'Abgelehnt', cls: 'red' },
        { value: s.rate_avg ? `${s.rate_avg}â‚¬` : 'â€”', label: 'Ã˜ Stundensatz', cls: 'yellow' },
        { value: s.match_score_avg ? `${s.match_score_avg}%` : 'â€”', label: 'Ã˜ Match Score', cls: 'purple' },
    ];
    grid.innerHTML = cards.map(c =>
        `<div class="stat-card ${c.cls}">
            <div class="value">${c.value}</div>
            <div class="label">${c.label}</div>
        </div>`
    ).join('');
}

/* â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function populateMonthFilter() {
    const months = dashboardData.statistics?.monthly_distribution || {};
    const sel = document.getElementById('monthFilter');
    Object.keys(months).sort().reverse().forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
    });
}

function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const monthFilter = document.getElementById('monthFilter').value;

    filteredApps = (dashboardData.applications || []).filter(app => {
        if (search) {
            const hay = [app.project_title, app.provider, app.location, app.notes, app.status]
                .filter(Boolean).join(' ').toLowerCase();
            if (!hay.includes(search)) return false;
        }
        if (statusFilter && classifyStatus(app.status) !== statusFilter) return false;
        if (monthFilter && !(app.date_recorded || '').startsWith(monthFilter)) return false;
        return true;
    });

    sortApps();
    currentPage = 0;
    renderTable();
}

document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('monthFilter').addEventListener('change', applyFilters);

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('monthFilter').value = '';
    applyFilters();
}

/* â”€â”€ Sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sortApps() {
    filteredApps.sort((a, b) => {
        let va = a[sortColumn], vb = b[sortColumn];
        if (va == null) va = '';
        if (vb == null) vb = '';
        if (typeof va === 'number' && typeof vb === 'number') {
            return sortAsc ? va - vb : vb - va;
        }
        va = String(va).toLowerCase();
        vb = String(vb).toLowerCase();
        return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
    });
}

document.querySelectorAll('thead th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortColumn === col) { sortAsc = !sortAsc; }
        else { sortColumn = col; sortAsc = col === 'project_title'; }
        document.querySelectorAll('thead th').forEach(h => h.classList.remove('sorted'));
        th.classList.add('sorted');
        th.querySelector('.sort-arrow').textContent = sortAsc ? 'â–²' : 'â–¼';
        applyFilters();
    });
});

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTable() {
    const tbody = document.getElementById('tableBody');
    const start = currentPage * PAGE_SIZE;
    const page = filteredApps.slice(start, start + PAGE_SIZE);

    document.getElementById('tableCount').textContent =
        `${filteredApps.length} von ${dashboardData.applications.length}`;

    tbody.innerHTML = page.map(app => {
        const cls = classifyStatus(app.status);
        const statusLabel = (app.status || 'â€”').replace(/^Bewerbung\s*/i, '');
        const dateStr = app.date_recorded ? new Date(app.date_recorded).toLocaleDateString('de-DE') : 'â€”';
        const rateStr = app.rate_eur_h ? `${app.rate_eur_h}â‚¬` : 'â€”';
        const matchStr = app.match_score ? `${app.match_score}%` : 'â€”';
        const titleHtml = app.source_url
            ? `<a href="${app.source_url}" target="_blank" style="color:var(--blue);text-decoration:none">${esc(app.project_title || 'â€”')}</a>`
            : esc(app.project_title || 'â€”');
        return `<tr>
            <td>${dateStr}</td>
            <td class="wrap">${titleHtml}</td>
            <td>${esc(app.provider || 'â€”')}</td>
            <td>${esc(app.location || 'â€”')}</td>
            <td>${rateStr}</td>
            <td>${matchStr}</td>
            <td><span class="status ${cls}">${esc(statusLabel)}</span></td>
        </tr>`;
    }).join('');

    renderPagination();
}

function esc(s) {
    const el = document.createElement('span');
    el.textContent = s;
    return el.innerHTML;
}

function renderPagination() {
    const total = Math.ceil(filteredApps.length / PAGE_SIZE);
    const pag = document.getElementById('pagination');
    if (total <= 1) { pag.innerHTML = ''; return; }
    pag.innerHTML = `
        <button onclick="goPage(0)" ${currentPage === 0 ? 'disabled' : ''}>Â«</button>
        <button onclick="goPage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>â€¹</button>
        <span>Seite ${currentPage + 1} / ${total}</span>
        <button onclick="goPage(${currentPage + 1})" ${currentPage >= total - 1 ? 'disabled' : ''}>â€º</button>
        <button onclick="goPage(${total - 1})" ${currentPage >= total - 1 ? 'disabled' : ''}>Â»</button>
    `;
}

function goPage(n) {
    currentPage = Math.max(0, Math.min(n, Math.ceil(filteredApps.length / PAGE_SIZE) - 1));
    renderTable();
    document.querySelector('.table-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCharts() {
    const s = dashboardData.statistics;
    const chartDefaults = {
        color: '#e4e4f0',
        borderColor: '#252542',
        font: { family: "-apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif" },
    };
    Chart.defaults.color = chartDefaults.color;

    /* Status Pie */
    const statusDist = s.status_distribution || {};
    charts.status = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusDist).map(k => STATUS_LABELS[k] || k),
            datasets: [{
                data: Object.values(statusDist),
                backgroundColor: Object.keys(statusDist).map(k => STATUS_COLORS[k] || '#a29bfe'),
                borderColor: '#1a1a2e', borderWidth: 2,
            }],
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 12, font: { size: 11 } } },
            },
        },
    });

    /* Monthly Bar */
    const monthly = s.monthly_distribution || {};
    charts.monthly = new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(monthly),
            datasets: [{
                label: 'Bewerbungen',
                data: Object.values(monthly),
                backgroundColor: 'rgba(108, 92, 231, 0.6)',
                borderColor: '#6c5ce7', borderWidth: 1, borderRadius: 4,
            }],
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(37,37,66,0.8)' } },
                y: { grid: { color: 'rgba(37,37,66,0.8)' }, beginAtZero: true,
                     ticks: { stepSize: 5 } },
            },
        },
    });

    /* Provider Bar (top 10) */
    const providers = s.top_providers || {};
    const provEntries = Object.entries(providers).slice(0, 10);
    charts.provider = new Chart(document.getElementById('providerChart'), {
        type: 'bar',
        data: {
            labels: provEntries.map(e => e[0].length > 25 ? e[0].slice(0, 22) + 'â€¦' : e[0]),
            datasets: [{
                label: 'Bewerbungen',
                data: provEntries.map(e => e[1]),
                backgroundColor: 'rgba(0, 206, 201, 0.5)',
                borderColor: '#00cec9', borderWidth: 1, borderRadius: 4,
            }],
        },
        options: {
            indexAxis: 'y', responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(37,37,66,0.8)' }, beginAtZero: true },
                y: { grid: { display: false } },
            },
        },
    });

    /* Rate Histogram */
    const apps = dashboardData.applications || [];
    const rates = apps.map(a => a.rate_eur_h).filter(Boolean);
    const buckets = {};
    rates.forEach(r => {
        const b = Math.floor(r / 10) * 10;
        const label = `${b}â€“${b + 10}`;
        buckets[label] = (buckets[label] || 0) + 1;
    });
    const sortedBuckets = Object.entries(buckets).sort((a, b) => {
        return parseInt(a[0]) - parseInt(b[0]);
    });
    charts.rate = new Chart(document.getElementById('rateChart'), {
        type: 'bar',
        data: {
            labels: sortedBuckets.map(e => e[0] + 'â‚¬'),
            datasets: [{
                label: 'Anzahl',
                data: sortedBuckets.map(e => e[1]),
                backgroundColor: 'rgba(253, 203, 110, 0.5)',
                borderColor: '#fdcb6e', borderWidth: 1, borderRadius: 4,
            }],
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(37,37,66,0.8)' } },
                y: { grid: { color: 'rgba(37,37,66,0.8)' }, beginAtZero: true },
            },
        },
    });
}

/* â”€â”€ Pipeline Trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openPipelineModal() {
    document.getElementById('pipelineModal').classList.add('active');
    document.getElementById('pipelineResult').className = 'result';
    document.getElementById('pipelineResult').style.display = 'none';
}

function closePipelineModal() {
    document.getElementById('pipelineModal').classList.remove('active');
}

async function triggerPipeline() {
    const token = document.getElementById('pipelineToken').value.trim();
    if (!token) { showPipelineResult('err', 'Bitte Token eingeben'); return; }

    const btn = document.getElementById('triggerBtn');
    btn.disabled = true; btn.textContent = 'â³ Wird gestartetâ€¦';

    try {
        const resp = await fetch(
            `https://gitlab.com/api/v4/projects/${PROJECT_ID}/pipeline`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'PRIVATE-TOKEN': token,
                },
                body: JSON.stringify({
                    ref: 'main',
                    variables: [
                        { key: 'APPLICATIONS_PIPELINE', value: 'true' },
                    ],
                }),
            }
        );
        const data = await resp.json();
    window._dashboardData = data;
        if (resp.ok) {
            showPipelineResult('ok',
                `âœ… Pipeline #${data.iid} gestartet â†’ <a href="${data.web_url}" target="_blank" style="color:var(--green)">Ã–ffnen</a>`);
        } else {
            showPipelineResult('err', `âŒ ${data.message || data.error || 'Fehler'}`);
        }
    } catch (err) {
        showPipelineResult('err', `âŒ Netzwerkfehler: ${err.message}`);
    } finally {
        btn.disabled = false; btn.textContent = 'ğŸš€ Starten';
    }
}

function showPipelineResult(type, msg) {
    const el = document.getElementById('pipelineResult');
    el.className = `result ${type}`;
    el.innerHTML = msg;
    el.style.display = 'block';
}

/* Click outside modal to close */
document.getElementById('pipelineModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closePipelineModal();
});


/* â”€â”€ Tab Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
    if (tab === 'review') loadReviewQueue();
}

/* â”€â”€ Review Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let reviewData = null;

async function loadReviewQueue() {
    const container = document.getElementById('reviewQueue');
    const paths = ['apptrack_review_queue.json', '../apptrack_review_queue.json',
                   'output/apptrack_review_queue.json'];
    let resp = null;
    for (const p of paths) {
        try { resp = await fetch(p); if (resp.ok) break; } catch {}
    }
    if (!resp || !resp.ok) {
        // Try to extract from dashboard.json crawl_results
        if (window._dashboardData && window._dashboardData.crawl_results) {
            const pending = window._dashboardData.crawl_results.filter(
                cr => cr.status === 'pending_review'
            );
            renderReviewFromCrawl(pending);
            return;
        }
        container.innerHTML = `<div class="review-empty">
            <div class="icon">ğŸ“­</div>
            <div>Keine Review-Daten verfÃ¼gbar.</div>
            <div style="margin-top:8px; font-size:0.85rem">
                Starte <code>apptrack:promote-review</code> in der Pipeline.
            </div></div>`;
        return;
    }
    reviewData = await resp.json();
    renderReviewQueue(reviewData.queue || []);
    renderReviewSummary(reviewData.summary || {});
}

function renderReviewQueue(queue) {
    const container = document.getElementById('reviewQueue');
    const badge = document.getElementById('reviewBadge');
    badge.textContent = queue.length;
    badge.style.display = queue.length > 0 ? 'inline' : 'none';

    if (!queue.length) {
        container.innerHTML = `<div class="review-empty">
            <div class="icon">âœ¨</div>
            <div>VorhÃ¶lle ist leer â€” alle Matches wurden bearbeitet.</div></div>`;
        return;
    }

    container.innerHTML = queue.map(item => {
        const scoreClass = (item.match_score || 0) >= 85 ? 'high' : 'mid';
        const tags = (item.keywords || []).map(k =>
            `<span class="review-tag">${esc(k)}</span>`).join('');
        const aiTag = item.is_ai
            ? '<span class="review-tag ai">ğŸ¤– AI Project</span>' : '';
        const remote = item.remote_percent
            ? `<span>ğŸ  ${item.remote_percent}% Remote</span>` : '';
        return `<div class="review-card" data-id="${item.id}">
            <div class="review-header">
                <div class="review-title">${esc(item.title)}</div>
                <div class="review-score ${scoreClass}">${item.match_score || 'â€”'}%</div>
            </div>
            <div class="review-meta">
                <span>ğŸ¢ ${esc(item.company)}</span>
                <span>ğŸ“ ${esc(item.location)}</span>
                ${remote}
                <span>ğŸ”— ${esc(item.source)}/${esc(item.external_id)}</span>
            </div>
            <div class="review-tags">${aiTag}${tags}</div>
            <div class="review-actions">
                <button class="btn approve" onclick="reviewAction(${item.id}, 'approve')">
                    âœ… Approve
                </button>
                <button class="btn dismiss" onclick="reviewAction(${item.id}, 'dismiss')">
                    âŒ Dismiss
                </button>
                ${item.url ? `<a class="btn secondary" href="${esc(item.url)}" target="_blank" style="text-decoration:none">ğŸ”— Ã–ffnen</a>` : ''}
            </div>
        </div>`;
    }).join('');
}

function renderReviewFromCrawl(pending) {
    const queue = pending.map(cr => ({
        id: cr.id, source: cr.source || 'â€”', external_id: cr.external_id || 'â€”',
        title: cr.title || 'â€”', match_score: cr.match_score,
        is_ai: (cr.match_reasons || {}).is_ai || false,
        keywords: (cr.match_reasons || {}).keywords || [],
        company: (cr.raw_data || {}).company || 'â€”',
        location: (cr.raw_data || {}).location || 'â€”',
        remote_percent: (cr.raw_data || {}).remote_percent,
        url: (cr.raw_data || {}).url || '',
    }));
    renderReviewQueue(queue);
}

function renderReviewSummary(summary) {
    const container = document.getElementById('reviewSummary');
    if (!summary.status_counts) return;
    const sc = summary.status_counts;
    const dist = summary.score_distribution || {};
    container.innerHTML = `
        <div class="review-summary-item">
            <div class="label">ğŸ”¥ Pending Review</div>
            <div class="value" style="color:var(--yellow)">${sc.pending_review || 0}</div>
        </div>
        <div class="review-summary-item">
            <div class="label">âœ… Applied</div>
            <div class="value" style="color:var(--green)">${sc.applied || 0}</div>
        </div>
        <div class="review-summary-item">
            <div class="label">âŒ Dismissed</div>
            <div class="value" style="color:var(--red)">${sc.dismissed || 0}</div>
        </div>
        <div class="review-summary-item">
            <div class="label">ğŸ“Š Score Range</div>
            <div class="value">${dist.min || 0}â€“${dist.max || 0}%</div>
        </div>`;
}

async function reviewAction(id, action) {
    const card = document.querySelector(`.review-card[data-id="${id}"]`);
    if (!card) return;

    // Visual feedback
    card.style.opacity = '0.5';
    card.style.pointerEvents = 'none';

    // Note: In production, this triggers a pipeline variable
    // For now, log the action (actual API integration via pipeline trigger)
    console.log(`Review action: ${action} for CrawlResult #${id}`);

    // Animate removal
    setTimeout(() => {
        card.style.transition = 'all 0.3s';
        card.style.maxHeight = '0';
        card.style.overflow = 'hidden';
        card.style.marginBottom = '0';
        card.style.padding = '0';
        card.style.opacity = '0';
        setTimeout(() => card.remove(), 300);
    }, 200);

    // Update badge
    const badge = document.getElementById('reviewBadge');
    const remaining = document.querySelectorAll('.review-card').length - 1;
    badge.textContent = remaining;
    if (remaining <= 0) badge.style.display = 'none';
}

/* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
loadDashboard();
</script>
</body>
</html>
