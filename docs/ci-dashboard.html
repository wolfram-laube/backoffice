<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CI Metrics Dashboard ‚Äî Blauweiss Ops</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #1a1a2e; --bg2: #16213e; --bg3: #0f3460;
    --fg: #e4e4e4; --fg2: #a0a0b0; --accent: #e94560;
    --green: #4ade80; --red: #f87171; --yellow: #fbbf24;
    --blue: #60a5fa; --purple: #a78bfa;
    --radius: 12px; --shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg); color: var(--fg);
    padding: 24px; max-width: 1400px; margin: 0 auto;
  }

  /* Header */
  .header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 28px; padding-bottom: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .header h1 { font-size: 1.6rem; font-weight: 700; }
  .header h1 span { color: var(--accent); }
  .header .meta { color: var(--fg2); font-size: 0.82rem; }

  /* KPI Cards */
  .kpi-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px; margin-bottom: 28px;
  }
  .kpi {
    background: var(--bg2); border-radius: var(--radius);
    padding: 20px; box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.05);
  }
  .kpi .label { font-size: 0.75rem; color: var(--fg2); text-transform: uppercase; letter-spacing: 0.05em; }
  .kpi .value { font-size: 2rem; font-weight: 800; margin-top: 4px; }
  .kpi .sub { font-size: 0.78rem; color: var(--fg2); margin-top: 2px; }
  .kpi.green .value { color: var(--green); }
  .kpi.red .value { color: var(--red); }
  .kpi.blue .value { color: var(--blue); }
  .kpi.purple .value { color: var(--purple); }
  .kpi.yellow .value { color: var(--yellow); }

  /* Charts */
  .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
  @media (max-width: 900px) { .charts { grid-template-columns: 1fr; } }
  .chart-card {
    background: var(--bg2); border-radius: var(--radius);
    padding: 20px; box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.05);
  }
  .chart-card h3 { font-size: 0.95rem; margin-bottom: 12px; color: var(--fg2); }
  .chart-card canvas { max-height: 260px; }

  /* Tables */
  .table-card {
    background: var(--bg2); border-radius: var(--radius);
    padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.05);
    overflow-x: auto;
  }
  .table-card h3 { font-size: 0.95rem; margin-bottom: 12px; color: var(--fg2); }
  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  th { text-align: left; padding: 8px 10px; color: var(--fg2); font-weight: 600;
       border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem;
       text-transform: uppercase; letter-spacing: 0.04em; }
  td { padding: 7px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); }
  tr:hover td { background: rgba(255,255,255,0.03); }
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 6px;
    font-size: 0.72rem; font-weight: 600;
  }
  .badge.pass { background: rgba(74,222,128,0.15); color: var(--green); }
  .badge.fail { background: rgba(248,113,113,0.15); color: var(--red); }
  .badge.warn { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .mono { font-family: 'SF Mono', Monaco, monospace; font-size: 0.78rem; }
  .msg { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--fg2); }

  /* Empty state */
  .empty { text-align: center; padding: 40px; color: var(--fg2); }
  .empty .icon { font-size: 2.5rem; margin-bottom: 12px; }
</style>
</head>
<body>

<div class="header">
  <h1>üìä CI <span>Metrics</span> Dashboard</h1>
  <div class="meta">
    Generated: <span id="gen-time"></span><br>
    Data source: BigQuery <code>myk8sproject-207017.ci_metrics</code>
  </div>
</div>

<div id="app"></div>

<script>
const DATA = {"summary": {"pipelines": 1, "runs": 1, "total_tests": 8, "total_passed": 7, "total_failed": 1, "total_skipped": 0, "pass_rate": 87.5, "avg_duration": 2.34, "last_ingested": "2026-02-05T16:02:34.788301+00:00"}, "pipeline_history": [{"pipeline_id": 99999, "ref": "feature/ci-metrics-phase2", "commit_sha": "abc123te", "jobs": "test:unit", "tests": 8, "passed": 7, "failed": 1, "pass_rate": 87.5, "duration": 2.3, "timestamp": "2026-02-05T16:02:34.788301+00:00"}], "daily_trend": [{"day": "2026-02-05", "pipelines": 1, "tests": 8, "passed": 7, "failed": 1, "pass_rate": 87.5, "avg_duration": 2.34}], "recent_failures": [{"pipeline_id": 99999, "job_name": "test:unit", "suite": "tests.unit.test_application_workflow", "test": "test_invoice_total", "classname": "tests.unit.test_billing.TestInvoice", "message": "AssertionError: 105.0 != 110.0", "duration": 0.445, "timestamp": "2026-02-05T16:02:34.788301+00:00"}], "flaky_tests": [], "job_stats": [{"job": "test:unit", "runs": 1, "tests": 8, "pass_rate": 87.5, "avg_duration": 2.34}], "generated_at": "2026-02-05T16:15:30.228419+00:00"};

const app = document.getElementById('app');
const s = DATA.summary;

// Format helpers
const fmt = (n) => n != null ? n.toLocaleString() : '‚Äî';
const fmtPct = (n) => n != null ? n.toFixed(1) + '%' : '‚Äî';
const fmtDur = (n) => n != null ? n.toFixed(1) + 's' : '‚Äî';
const fmtTime = (iso) => {
  if (!iso) return '‚Äî';
  const d = new Date(iso);
  return d.toLocaleDateString('de-AT', { day: '2-digit', month: '2-digit', year: '2-digit' })
    + ' ' + d.toLocaleTimeString('de-AT', { hour: '2-digit', minute: '2-digit' });
};
const passClass = (rate) => rate >= 95 ? 'pass' : rate >= 80 ? 'warn' : 'fail';

document.getElementById('gen-time').textContent = fmtTime(DATA.generated_at);

// Empty state check
if (!s.pipelines) {
  app.innerHTML = `<div class="empty"><div class="icon">üì≠</div>
    <h3>No test data yet</h3>
    <p>Run a pipeline with test jobs to see metrics here.</p></div>`;
} else {

  // ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ
  app.innerHTML = `
  <div class="kpi-grid">
    <div class="kpi blue"><div class="label">Pipelines</div>
      <div class="value">${fmt(s.pipelines)}</div>
      <div class="sub">${fmt(s.runs)} test suite runs</div></div>
    <div class="kpi ${s.pass_rate >= 95 ? 'green' : s.pass_rate >= 80 ? 'yellow' : 'red'}">
      <div class="label">Pass Rate</div>
      <div class="value">${fmtPct(s.pass_rate)}</div>
      <div class="sub">${fmt(s.total_passed)} / ${fmt(s.total_tests)} tests</div></div>
    <div class="kpi red"><div class="label">Failures</div>
      <div class="value">${fmt(s.total_failed)}</div>
      <div class="sub">${fmt(s.total_skipped)} skipped</div></div>
    <div class="kpi purple"><div class="label">Avg Duration</div>
      <div class="value">${fmtDur(s.avg_duration)}</div>
      <div class="sub">per test suite</div></div>
    <div class="kpi yellow"><div class="label">Last Ingested</div>
      <div class="value" style="font-size:1.1rem">${fmtTime(s.last_ingested)}</div>
      <div class="sub">most recent data</div></div>
  </div>

  <div class="charts">
    <div class="chart-card"><h3>üìà Pass Rate Trend (30 days)</h3><canvas id="chartPassRate"></canvas></div>
    <div class="chart-card"><h3>‚è±Ô∏è Duration Trend (30 days)</h3><canvas id="chartDuration"></canvas></div>
  </div>

  <div class="table-card"><h3>üèóÔ∏è Job Breakdown</h3>
    <table><thead><tr><th>Job</th><th>Runs</th><th>Tests</th><th>Pass Rate</th><th>Avg Duration</th></tr></thead>
    <tbody>${DATA.job_stats.map(j => `<tr>
      <td class="mono">${j.job}</td><td>${fmt(j.runs)}</td><td>${fmt(j.tests)}</td>
      <td><span class="badge ${passClass(j.pass_rate)}">${fmtPct(j.pass_rate)}</span></td>
      <td>${fmtDur(j.avg_duration)}</td></tr>`).join('')}</tbody></table>
  </div>

  <div class="table-card"><h3>üî¥ Recent Failures</h3>
    ${DATA.recent_failures.length ? `<table><thead><tr>
      <th>Pipeline</th><th>Job</th><th>Test</th><th>Message</th><th>When</th></tr></thead>
    <tbody>${DATA.recent_failures.map(f => `<tr>
      <td class="mono">#${f.pipeline_id}</td>
      <td class="mono">${f.job_name}</td>
      <td class="mono">${f.test}</td>
      <td class="msg" title="${f.message.replace(/"/g, '&quot;')}">${f.message || '‚Äî'}</td>
      <td>${fmtTime(f.timestamp)}</td></tr>`).join('')}</tbody></table>`
    : '<p style="color:var(--fg2);text-align:center;padding:20px">üéâ No failures!</p>'}
  </div>

  ${DATA.flaky_tests.length ? `<div class="table-card"><h3>üîÑ Flaky Tests (failed in multiple pipelines)</h3>
    <table><thead><tr><th>Test</th><th>Class</th><th>Failures</th><th>Pipelines</th><th>Last Failure</th></tr></thead>
    <tbody>${DATA.flaky_tests.map(f => `<tr>
      <td class="mono">${f.test}</td><td class="mono">${f.classname}</td>
      <td><span class="badge fail">${f.failures}</span></td>
      <td>${f.pipelines}</td><td>${fmtTime(f.last)}</td></tr>`).join('')}</tbody></table>
  </div>` : ''}

  <div class="table-card"><h3>üìã Pipeline History (last 50)</h3>
    <table><thead><tr><th>Pipeline</th><th>Branch</th><th>Commit</th><th>Jobs</th>
      <th>Tests</th><th>Pass Rate</th><th>Duration</th><th>When</th></tr></thead>
    <tbody>${DATA.pipeline_history.map(p => `<tr>
      <td class="mono">#${p.pipeline_id}</td>
      <td class="mono">${p.ref}</td>
      <td class="mono">${p.commit_sha}</td>
      <td class="mono">${p.jobs}</td>
      <td>${fmt(p.tests)}</td>
      <td><span class="badge ${passClass(p.pass_rate)}">${fmtPct(p.pass_rate)}</span></td>
      <td>${fmtDur(p.duration)}</td>
      <td>${fmtTime(p.timestamp)}</td></tr>`).join('')}</tbody></table>
  </div>`;

  // ‚îÄ‚îÄ Charts ‚îÄ‚îÄ
  const trend = DATA.daily_trend;
  if (trend.length > 0) {
    const labels = trend.map(d => d.day.slice(5));  // MM-DD

    new Chart(document.getElementById('chartPassRate'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Pass Rate %',
          data: trend.map(d => d.pass_rate),
          borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)',
          fill: true, tension: 0.3, pointRadius: 3,
        }, {
          label: 'Failures',
          data: trend.map(d => d.failed),
          borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)',
          fill: true, tension: 0.3, pointRadius: 3, yAxisID: 'y1',
        }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { beginAtZero: false, min: 0, max: 105, title: { display: true, text: 'Pass Rate %', color: '#a0a0b0' },
               ticks: { color: '#a0a0b0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y1: { position: 'right', beginAtZero: true, title: { display: true, text: 'Failures', color: '#a0a0b0' },
                ticks: { color: '#a0a0b0' }, grid: { drawOnChartArea: false } },
          x: { ticks: { color: '#a0a0b0' }, grid: { color: 'rgba(255,255,255,0.05)' } }
        },
        plugins: { legend: { labels: { color: '#e4e4e4' } } }
      }
    });

    new Chart(document.getElementById('chartDuration'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Avg Duration (s)',
          data: trend.map(d => d.avg_duration),
          backgroundColor: 'rgba(96,165,250,0.6)', borderColor: '#60a5fa', borderWidth: 1,
        }, {
          label: 'Tests Run',
          data: trend.map(d => d.tests),
          type: 'line', borderColor: '#a78bfa',
          tension: 0.3, pointRadius: 3, yAxisID: 'y1',
        }]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Duration (s)', color: '#a0a0b0' },
               ticks: { color: '#a0a0b0' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y1: { position: 'right', beginAtZero: true, title: { display: true, text: 'Tests', color: '#a0a0b0' },
                ticks: { color: '#a0a0b0' }, grid: { drawOnChartArea: false } },
          x: { ticks: { color: '#a0a0b0' }, grid: { color: 'rgba(255,255,255,0.05)' } }
        },
        plugins: { legend: { labels: { color: '#e4e4e4' } } }
      }
    });
  }
}
</script>
</body>
</html>