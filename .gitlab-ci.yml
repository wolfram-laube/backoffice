# =============================================================================
# BLAUWEISS BACKOFFICE - CI/CD Orchestrator
# =============================================================================
# Central orchestrator for Operations CI/CD pipelines.
# Research projects (CLARISSA, etc.) live in their own repos.
#
# Architecture:
#   - Business operations (Billing, Applications)
#   - Platform services (Pages, CI Automation)
# =============================================================================

# -----------------------------------------------------------------------------
# INCLUDES: Domain-specific CI configurations
# -----------------------------------------------------------------------------
include:
  # === BUSINESS OPERATIONS ===
  - local: '.gitlab/billing.yml'            # Invoicing, Timesheets, Email
  - local: '.gitlab/applications.yml'       # Job Applications Pipeline

  # === PLATFORM SERVICES ===
  - local: '.gitlab/pages.yml'              # MkDocs Portal
  - local: '.gitlab/ci-automation.yml'      # CRM Bots

# -----------------------------------------------------------------------------
# WORKFLOW: Pipeline trigger rules
# -----------------------------------------------------------------------------
workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: always
    - when: never

# -----------------------------------------------------------------------------
# DEFAULT: Shared configuration
# -----------------------------------------------------------------------------
default:
  image: python:3.11-slim
  tags:
    - gitlab-org-docker

# -----------------------------------------------------------------------------
# STAGES
# -----------------------------------------------------------------------------
stages:
  - classify
  - automation
  - validate
  - build
  - test
  - deploy
  - notify
  - cleanup

# -----------------------------------------------------------------------------
# VARIABLES
# -----------------------------------------------------------------------------
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR"
  # Project IDs
  CRM_PROJECT_ID: "78171527"
  BACKOFFICE_PROJECT_ID: "77555895"
  BLAUWEISS_GROUP_ID: "120698013"

# -----------------------------------------------------------------------------
# CACHE
# -----------------------------------------------------------------------------
cache:
  key: "${CI_JOB_NAME}"
  paths:
    - .cache/pip
    - venv/

# -----------------------------------------------------------------------------
# TEMPLATES
# -----------------------------------------------------------------------------
.python-setup:
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt 2>/dev/null || true
