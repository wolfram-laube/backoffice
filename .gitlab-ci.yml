# =============================================================================
# BLAUWEISS BACKOFFICE - CI/CD Orchestrator
# =============================================================================
# Central orchestrator for Operations CI/CD pipelines.
# Research projects (CLARISSA, etc.) live in their own repos.
#
# Architecture:
#   - Business operations (Billing, Applications)
#   - Platform services (Pages, CI Automation)
# =============================================================================

# -----------------------------------------------------------------------------
# INCLUDES: Domain-specific CI configurations
# -----------------------------------------------------------------------------
include:
  # === BUSINESS OPERATIONS ===
  - local: '.gitlab/billing.yml'            # Invoicing, Timesheets, Email
  - local: '.gitlab/applications.yml'       # Job Applications Pipeline

  # === PLATFORM SERVICES ===
  - local: '.gitlab/pages.yml'              # MkDocs Portal
  - local: '.gitlab/ci-automation.yml'      # CRM Bots
  # === INTEGRATIONS ===
  - local: '.gitlab/gmail-drafts.yml'
  - local: '.gitlab/gdrive-upload.yml'

  # === INFRASTRUCTURE ===
  - local: '.gitlab/runner-fallback.yml'     # Dynamic runner selection
  - local: '.gitlab/gcp-check.yml'           # GCP status
  - local: '.gitlab/gcp-setup.yml'
  - local: '.gitlab/gcp-migration.yml'     # Nordic migration           # GCP setup
  # - local: '.gitlab/gcp-vm-control.yml'    # Merged into runner-fallback.yml      # VM start/stop
  - local: '.gitlab/terraform.yml'           # IaC
  - local: '.gitlab/docker-build.yml'        # Container builds
  - local: '.gitlab/cloud-run.yml'         # Cloud Run deployments
  - local: '.gitlab/ci-metrics.yml'        # CI Metrics Collector
  - local: '.gitlab/k3s-setup.yml'           # Kubernetes
  - local: '.gitlab/infra-setup.yml'         # General infra
  - local: '.gitlab/benchmark.yml'           # Performance tests
  - local: '.gitlab/fix-shell-runner.yml'    # Runner fixes
  - local: '.gitlab/parallel-jobs.yml'       # Parallelization

  # === MAB RUNNER INTEGRATION ===
  - local: '.gitlab/mab-integration.yml'     # MAB intelligent runner selection

  # === QUALITY ASSURANCE ===
  - local: '.gitlab/tests.yml'
  - local: '.gitlab/nsai-tests.yml'       # NSAI Symbolic Layer tests            # Pytest unit/integration tests
  - local: '.gitlab/publications.yml'      # Quarto publication builds (GOV-003)
  - local: '.gitlab/roundtrip-test.yml'      # Workflow integration test

# -----------------------------------------------------------------------------
# WORKFLOW: Pipeline trigger rules
# -----------------------------------------------------------------------------
workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "api"'
      when: always
    - when: never

# -----------------------------------------------------------------------------
# DEFAULT: Shared configuration
# -----------------------------------------------------------------------------
default:
  image: python:3.11-slim
  tags:
    - docker-any

# -----------------------------------------------------------------------------
# STAGES
# -----------------------------------------------------------------------------
stages:
  - classify
  - automation
  - validate
  - build
  - test
  - deploy
  - notify
  - cleanup

# -----------------------------------------------------------------------------
# VARIABLES
# -----------------------------------------------------------------------------
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR"
  # Project IDs
  CRM_PROJECT_ID: "78171527"
  BACKOFFICE_PROJECT_ID: "77555895"
  BLAUWEISS_GROUP_ID: "120698013"

# -----------------------------------------------------------------------------
# CACHE
# -----------------------------------------------------------------------------
cache:
  key: "${CI_JOB_NAME}"
  paths:
    - .cache/pip
    - venv/

# -----------------------------------------------------------------------------
# TEMPLATES
# -----------------------------------------------------------------------------
.python-setup:
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt 2>/dev/null || true
