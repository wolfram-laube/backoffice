stages:
  - lint
  - test
  - build
  - deploy

# ═══════════════════════════════════════════════════════════════
# LINTING
# ═══════════════════════════════════════════════════════════════

lint:flake8:
  stage: lint
  script:
    - pip install flake8 -q --break-system-packages 2>/dev/null || pip install flake8 -q
    - flake8 modules/ --max-line-length=120 --ignore=E501,W503 || true
  allow_failure: true

lint:black:
  stage: lint
  script:
    - pip install black -q --break-system-packages 2>/dev/null || pip install black -q
    - black --check modules/ || true
  allow_failure: true

# ═══════════════════════════════════════════════════════════════
# TESTING
# ═══════════════════════════════════════════════════════════════

test:syntax:
  stage: test
  script:
    - python3 -m py_compile modules/**/*.py || find modules -name "*.py" -exec python3 -m py_compile {} \;

test:imports:
  stage: test
  script:
    - python3 -c "from modules.applications import ApplicationService" || true
    - python3 -c "from modules.invoicing import InvoiceService" || true

# ═══════════════════════════════════════════════════════════════
# BUILD
# ═══════════════════════════════════════════════════════════════

build:wheel:
  stage: build
  script:
    - pip install build -q --break-system-packages 2>/dev/null || pip install build -q
    - python3 -m build --wheel 2>/dev/null || echo "No pyproject.toml yet"
  artifacts:
    paths:
      - dist/*.whl
    expire_in: 7 days
  allow_failure: true

# ═══════════════════════════════════════════════════════════════
# INVOICE GENERATION (triggered by timesheet changes)
# ═══════════════════════════════════════════════════════════════

invoice:generate:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - timesheets/**/*.yaml
        - timesheets/**/*.yml
  before_script:
    - pip install pyyaml --break-system-packages -q 2>/dev/null || pip install pyyaml -q
    - |
      if ! command -v typst &> /dev/null; then
        echo "Installing Typst..."
        curl -L -o /tmp/typst.tar.xz https://github.com/typst/typst/releases/download/v0.12.0/typst-x86_64-unknown-linux-musl.tar.xz 2>/dev/null
        cd /tmp && tar -xf typst.tar.xz
        mkdir -p $HOME/bin
        mv typst-x86_64-unknown-linux-musl/typst $HOME/bin/
        export PATH="$HOME/bin:$PATH"
      fi
      typst --version || echo "Typst not available on this runner"
  script:
    - export PATH="$HOME/bin:$PATH"
    - mkdir -p invoices
    - python3 scripts/generate-invoices.py || echo "Invoice generation skipped"
  artifacts:
    paths:
      - invoices/*.pdf
    expire_in: 90 days
  allow_failure: true

# ═══════════════════════════════════════════════════════════════
# PAGES (Timesheet App + Documentation)
# ═══════════════════════════════════════════════════════════════

pages:
  stage: deploy
  script:
    - mkdir -p public
    - cp public/timesheet.html public/index.html 2>/dev/null || echo "<h1>Freelancer Admin</h1>" > public/index.html
  artifacts:
    paths:
      - public
  only:
    - main
