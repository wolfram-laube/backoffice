# ══════════════════════════════════════════════════════════════
# GitLab CI/CD Pipeline - Freelancer Admin
# ══════════════════════════════════════════════════════════════
#
# Runner Setup:
#   - mac-shell  (tags: shell, macos)     → Mac, läuft bei Login
#   - mac-docker (tags: docker, macos)    → Mac, wenn Docker läuft
#   - gcp-shell  (tags: shell, gcp)       → GCP VM, 24/7
#   - gcp-docker (tags: docker, gcp)      → GCP VM, 24/7
#
# Priorität: GCP (immer online) > Mac (bei Bedarf)
#
# ══════════════════════════════════════════════════════════════

stages:
  - lint
  - test
  - build
  - package

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  PYTHON_VERSION: "3.11"

cache:
  paths:
    - .pip-cache/
    - venv/

# ══════════════════════════════════════════════════════════════
# DEFAULT: Shell Runner (GCP oder Mac)
# ══════════════════════════════════════════════════════════════

default:
  tags:
    - shell  # Nimmt ersten verfügbaren: gcp-shell oder mac-shell

# ══════════════════════════════════════════════════════════════
# TEMPLATES
# ══════════════════════════════════════════════════════════════

.python-setup-linux: &python-setup-linux
  before_script:
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt

.python-setup-mac: &python-setup-mac
  tags:
    - shell
    - macos
  before_script:
    - python3 -m venv venv || python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt

# ══════════════════════════════════════════════════════════════
# STAGE: LINT
# ══════════════════════════════════════════════════════════════

lint:flake8:
  <<: *python-setup-linux
  stage: lint
  script:
    - pip install flake8
    - flake8 modules/ common/ --max-line-length=100 --ignore=E501,W503 || true
  allow_failure: true

lint:black:
  <<: *python-setup-linux
  stage: lint
  script:
    - pip install black
    - black --check --line-length=100 modules/ common/ || true
  allow_failure: true

# ══════════════════════════════════════════════════════════════
# STAGE: TEST
# ══════════════════════════════════════════════════════════════

test:syntax:
  <<: *python-setup-linux
  stage: test
  script:
    - python3 -m py_compile modules/applications/bewerbung.py
    - python3 -m py_compile modules/applications/service.py
    - python3 -m py_compile common/models/base.py
    - python3 -m py_compile cli.py
    - echo "✓ Syntax OK"

test:imports:
  <<: *python-setup-linux
  stage: test
  script:
    - python3 -c "from common.models import Client, Project, Contact; print('✓ common.models')"
    - python3 -c "from modules.applications.service import ApplicationService; print('✓ modules.applications')" || echo "⚠️ Import check"
    - echo "✓ Import check done"
  allow_failure: true

test:unit:
  <<: *python-setup-linux
  stage: test
  script:
    - pip install pytest pytest-cov
    - pytest tests/ -v --cov=modules --cov=common --cov-report=term-missing --cov-report=html || echo "No tests yet"
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - exists:
        - tests/test_*.py

# ══════════════════════════════════════════════════════════════
# STAGE: BUILD
# ══════════════════════════════════════════════════════════════

build:wheel:
  <<: *python-setup-linux
  stage: build
  script:
    - pip install build
    - python3 -m build --wheel
    - ls -la dist/
  artifacts:
    paths:
      - dist/*.whl
    expire_in: 4 weeks
    name: "freelancer-admin-${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

# ══════════════════════════════════════════════════════════════
# STAGE: PACKAGE
# ══════════════════════════════════════════════════════════════

# Linux Binary (auf GCP)
package:linux:
  <<: *python-setup-linux
  stage: package
  tags:
    - shell
    - gcp
    - linux
  script:
    - pip install pyinstaller
    - pyinstaller --onefile --name freelancer-admin-linux cli.py
    - chmod +x dist/freelancer-admin-linux
  artifacts:
    paths:
      - dist/freelancer-admin-linux
    expire_in: 4 weeks
  rules:
    - if: $CI_COMMIT_TAG
  when: manual

# macOS Binary
package:macos:
  <<: *python-setup-mac
  stage: package
  script:
    - pip install pyinstaller
    - pyinstaller --onefile --name freelancer-admin-macos cli.py
    - chmod +x dist/freelancer-admin-macos
  artifacts:
    paths:
      - dist/freelancer-admin-macos
    expire_in: 4 weeks
  rules:
    - if: $CI_COMMIT_TAG
  when: manual

# ══════════════════════════════════════════════════════════════
# DOCKER BUILD
# ══════════════════════════════════════════════════════════════

# Docker auf GCP (bevorzugt - immer online)
docker:build:gcp:
  stage: package
  tags:
    - docker
    - gcp
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
        docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG
      fi
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - Dockerfile
        - modules/**/*
        - common/**/*
  when: manual
  allow_failure: true

# Docker auf Mac (Fallback)
docker:build:mac:
  stage: package
  tags:
    - shell
    - macos
  script:
    - |
      if ! docker info > /dev/null 2>&1; then
        echo "⚠️ Docker not running - skipping"
        exit 0
      fi
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - Dockerfile
  when: manual
  allow_failure: true

# ══════════════════════════════════════════════════════════════
# PAGES
# ══════════════════════════════════════════════════════════════

pages:
  stage: package
  script:
    - mkdir -p public
    - cp -r htmlcov/* public/ 2>/dev/null || echo "No coverage"
    - echo "<h1>Freelancer Admin CI</h1><p>Build ${CI_COMMIT_SHORT_SHA}</p>" > public/index.html
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs:
    - job: test:unit
      optional: true
