# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  BLAUWEISS PORTAL - CI/CD PIPELINE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
#  Runner-Strategie:
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  â€¢ Standard Jobs (lint, test, build) â†’ GitLab Shared Runners (free, Docker)
#  â€¢ Deploy Jobs (Cloud Run, K8s)      â†’ Eigene Runner (Mac/GCP, shell)
#  â€¢ K8s Showcase                      â†’ GCP Runner mit k3s
#
#  Tags:
#  â”€â”€â”€â”€â”€
#  â€¢ (none)     â†’ Shared Runner (Docker)
#  â€¢ [deploy]   â†’ Mac oder GCP (shell, fÃ¼r gcloud/kubectl)
#  â€¢ [k8s]      â†’ Nur GCP (hat k3s installiert)
#  â€¢ [mac]      â†’ Nur Mac (wenn spezifisch nÃ¶tig)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

stages:
  - lint
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  LINTING - Shared Runners (Docker)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

lint:flake8:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install flake8 -q
    - flake8 modules/ --max-line-length=120 --ignore=E501,W503 || true
  allow_failure: true

lint:black:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install black -q
    - black --check modules/ || true
  allow_failure: true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  TESTING - Shared Runners (Docker)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test:syntax:
  stage: test
  image: python:3.11-slim
  script:
    - find modules -name "*.py" -exec python -m py_compile {} \;

test:imports:
  stage: test
  image: python:3.11-slim
  script:
    - pip install pyyaml -q
    - python -c "from modules.invoicing import InvoiceService" || true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  BUILD - Shared Runners (Docker)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

build:backend:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "$GCP_SA_KEY" > /tmp/sa-key.json
    - cat /tmp/sa-key.json | docker login -u _json_key --password-stdin https://gcr.io
  script:
    - |
      if [ -f "backend/Dockerfile" ]; then
        docker build -t gcr.io/myk8sproject-207017/blauweiss-api:$CI_COMMIT_SHA ./backend
        docker push gcr.io/myk8sproject-207017/blauweiss-api:$CI_COMMIT_SHA
        docker tag gcr.io/myk8sproject-207017/blauweiss-api:$CI_COMMIT_SHA gcr.io/myk8sproject-207017/blauweiss-api:latest
        docker push gcr.io/myk8sproject-207017/blauweiss-api:latest
        echo "âœ… Backend image pushed"
      else
        echo "â­ï¸ No backend/Dockerfile yet"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - backend/**/*
    - if: $CI_COMMIT_MESSAGE =~ /\[build\]/

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  INVOICE GENERATION - Shell Runner (braucht Typst)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

invoice:generate:
  stage: build
  tags: [deploy]  # Mac oder GCP - beide haben shell
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - timesheets/**/*.yaml
        - timesheets/**/*.yml
  before_script:
    - pip install pyyaml --break-system-packages -q 2>/dev/null || pip install pyyaml -q
    - |
      if ! command -v typst &> /dev/null; then
        echo "Installing Typst..."
        curl -sL -o /tmp/typst.tar.xz https://github.com/typst/typst/releases/download/v0.12.0/typst-x86_64-unknown-linux-musl.tar.xz
        cd /tmp && tar -xf typst.tar.xz
        mkdir -p $HOME/bin
        mv typst-x86_64-unknown-linux-musl/typst $HOME/bin/ 2>/dev/null || mv typst-*/typst $HOME/bin/
        export PATH="$HOME/bin:$PATH"
      fi
  script:
    - export PATH="$HOME/bin:$PATH"
    - mkdir -p invoices
    - python3 scripts/generate-invoices.py || echo "Invoice generation skipped"
  artifacts:
    paths:
      - invoices/*.pdf
    expire_in: 90 days
  allow_failure: true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  DEPLOY: CLOUD RUN (Production) - Shell Runner
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

deploy:cloudrun:
  stage: deploy
  tags: [deploy]  # Mac oder GCP
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - backend/**/*
    - if: $CI_COMMIT_MESSAGE =~ /\[deploy\]/
      when: manual
  before_script:
    - echo "$GCP_SA_KEY" > /tmp/sa-key.json
    - gcloud auth activate-service-account --key-file=/tmp/sa-key.json
    - gcloud config set project myk8sproject-207017
  script:
    - |
      echo "ðŸš€ Deploying to Cloud Run..."
      
      if gcloud run services describe blauweiss-api --region=europe-west1 &>/dev/null; then
        gcloud run deploy blauweiss-api \
          --image gcr.io/myk8sproject-207017/blauweiss-api:$CI_COMMIT_SHA \
          --region europe-west1 \
          --platform managed \
          --allow-unauthenticated
        
        URL=$(gcloud run services describe blauweiss-api --region=europe-west1 --format='value(status.url)')
        echo "âœ… Deployed: $URL"
      else
        echo "â­ï¸ Cloud Run service not yet created"
        echo "   Run: gcloud run deploy blauweiss-api --image gcr.io/myk8sproject-207017/blauweiss-api:latest --region europe-west1"
      fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  DEPLOY: K8s SHOWCASE - GCP Runner mit k3s
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

deploy:k8s:
  stage: deploy
  tags: [k8s]  # Nur GCP Runner (hat k3s)
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - infra/k8s/**/*
        - backend/**/*
        - portal/**/*
    - if: $CI_COMMIT_MESSAGE =~ /\[k8s-deploy\]/
  script:
    - |
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      
      echo "â˜¸ï¸ Deploying to K8s Showcase..."
      
      # Manifests anwenden
      kubectl apply -f infra/k8s/all-in-one.yaml
      
      # Secret aktualisieren
      kubectl create secret generic gitlab-credentials \
        --namespace=blauweiss \
        --from-literal=GITLAB_TOKEN="$GITLAB_TOKEN" \
        --from-literal=GITLAB_PROJECT_ID="$CI_PROJECT_ID" \
        --dry-run=client -o yaml | kubectl apply -f -
      
      # Rollout
      kubectl rollout restart deployment -n blauweiss 2>/dev/null || true
      
      echo ""
      echo "ðŸ“¦ Pods:"
      kubectl get pods -n blauweiss
      
      EXTERNAL_IP=$(curl -s ifconfig.me)
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âœ… K8s Showcase: http://$EXTERNAL_IP:30080"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# K8s Setup - einmalig oder bei Infrastruktur-Ã„nderungen
k8s:setup:
  stage: deploy
  tags: [k8s]
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[k8s-setup\]/
    - when: manual
  script:
    - |
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      
      echo "â˜¸ï¸ K8s Setup..."
      
      # Ingress-Nginx installieren
      kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/baremetal/deploy.yaml
      
      sleep 30
      
      # NodePort auf 30080
      kubectl patch svc ingress-nginx-controller -n ingress-nginx --type=json \
        -p='[{"op": "replace", "path": "/spec/ports/0/nodePort", "value": 30080}]' || true
      
      # Namespace
      kubectl create namespace blauweiss --dry-run=client -o yaml | kubectl apply -f -
      
      echo "âœ… K8s Setup complete"
      kubectl get nodes
      kubectl get pods -n ingress-nginx

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  PAGES - Shared Runner (statisches Frontend)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

pages:
  stage: deploy
  image: node:20-slim
  script:
    - |
      mkdir -p public
      
      # Frontend bauen wenn vorhanden
      if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
        cd frontend
        npm ci
        npm run build
        mv dist/* ../public/
      else
        # Fallback: statische Files kopieren
        cp portal/frontend/index.html public/index.html 2>/dev/null || echo "<h1>Blauweiss Portal</h1>" > public/index.html
      fi
  artifacts:
    paths:
      - public
  only:
    - main
